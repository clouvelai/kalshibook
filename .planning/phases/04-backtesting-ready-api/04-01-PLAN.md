---
phase: 04-backtesting-ready-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260216000001_create_trades.sql
  - supabase/migrations/20260216000002_create_settlements.sql
  - supabase/migrations/20260216000003_create_events_series.sql
  - supabase/migrations/20260216000004_extend_markets.sql
  - supabase/migrations/20260216000005_update_partition_function.sql
  - src/api/models.py
autonomous: true

must_haves:
  truths:
    - "trades table exists with daily partitioning matching the deltas pattern"
    - "settlements table exists with denormalized result/settlement_value columns"
    - "events and series tables exist for hierarchy storage"
    - "markets table has series_ticker column for hierarchy linking"
    - "partition function creates trades partitions alongside deltas"
    - "API request/response models exist for all Phase 4 endpoints"
  artifacts:
    - path: "supabase/migrations/20260216000001_create_trades.sql"
      provides: "Partitioned trades table"
      contains: "PARTITION BY RANGE"
    - path: "supabase/migrations/20260216000002_create_settlements.sql"
      provides: "Settlements table with denormalized columns"
      contains: "settlement_value"
    - path: "supabase/migrations/20260216000003_create_events_series.sql"
      provides: "Events and series hierarchy tables"
      contains: "CREATE TABLE events"
    - path: "supabase/migrations/20260216000004_extend_markets.sql"
      provides: "series_ticker column on markets"
      contains: "series_ticker"
    - path: "supabase/migrations/20260216000005_update_partition_function.sql"
      provides: "Updated partition function for trades"
      contains: "trades_"
    - path: "src/api/models.py"
      provides: "Pydantic models for trades, settlements, candles, events"
      contains: "TradesRequest"
  key_links:
    - from: "supabase/migrations/20260216000001_create_trades.sql"
      to: "supabase/migrations/20260216000005_update_partition_function.sql"
      via: "partition function must know about trades table"
      pattern: "trades_"
    - from: "supabase/migrations/20260216000003_create_events_series.sql"
      to: "supabase/migrations/20260216000004_extend_markets.sql"
      via: "markets.series_ticker references series.ticker conceptually"
      pattern: "series_ticker"
---

<objective>
Create all database tables and API models needed for Phase 4 backtesting endpoints.

Purpose: Establish the data foundation that both the collector extension (Plan 02) and API endpoints (Plans 03-04) depend on. All tables, indexes, and Pydantic models in one plan so downstream work can proceed in parallel.

Output: 5 migration files + updated API models file.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/migrations/20260213000001_create_markets.sql
@supabase/migrations/20260213000003_create_deltas.sql
@supabase/migrations/20260213000006_partition_management.sql
@src/api/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migrations for trades, settlements, events, series, and partition updates</name>
  <files>
    supabase/migrations/20260216000001_create_trades.sql
    supabase/migrations/20260216000002_create_settlements.sql
    supabase/migrations/20260216000003_create_events_series.sql
    supabase/migrations/20260216000004_extend_markets.sql
    supabase/migrations/20260216000005_update_partition_function.sql
  </files>
  <action>
Create 5 migration files following the existing naming pattern (YYYYMMDDNNNNNN_description.sql):

**20260216000001_create_trades.sql** -- Partitioned trades table (daily, like deltas):
```sql
CREATE TABLE trades (
    id BIGINT GENERATED ALWAYS AS IDENTITY,
    trade_id TEXT NOT NULL,
    market_ticker TEXT NOT NULL,
    yes_price INT NOT NULL,
    no_price INT NOT NULL,
    count INT NOT NULL,
    taker_side TEXT NOT NULL CHECK (taker_side IN ('yes', 'no')),
    ts TIMESTAMPTZ NOT NULL,
    received_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    PRIMARY KEY (ts, id)
) PARTITION BY RANGE (ts);
```
Add indexes: `idx_trades_ticker_ts ON trades (market_ticker, ts)` and `idx_trades_trade_id ON trades (trade_id)`.
Create initial daily partitions for 2026-02-16 through 2026-02-23 (same pattern as deltas migration).

**20260216000002_create_settlements.sql** -- Settlements table with denormalized columns:
```sql
CREATE TABLE settlements (
    market_ticker TEXT PRIMARY KEY,
    event_ticker TEXT,
    result TEXT CHECK (result IN ('yes', 'no', 'all_no', 'all_yes', 'void')),
    settlement_value INT,
    determined_at TIMESTAMPTZ,
    settled_at TIMESTAMPTZ,
    source TEXT DEFAULT 'lifecycle',
    metadata JSONB,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```
Add indexes: `idx_settlements_event ON settlements (event_ticker)`, `idx_settlements_result ON settlements (result)`.
Do NOT add FK to markets -- same performance reasoning as deltas table.

**20260216000003_create_events_series.sql** -- Events and series tables:
```sql
CREATE TABLE series (
    ticker TEXT PRIMARY KEY,
    title TEXT,
    frequency TEXT,
    category TEXT,
    tags TEXT[],
    settlement_sources JSONB,
    metadata JSONB,
    discovered_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    last_updated TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE events (
    event_ticker TEXT PRIMARY KEY,
    series_ticker TEXT,
    title TEXT,
    sub_title TEXT,
    category TEXT,
    mutually_exclusive BOOLEAN,
    status TEXT,
    strike_date TIMESTAMPTZ,
    strike_period TEXT,
    metadata JSONB,
    discovered_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    last_updated TIMESTAMPTZ NOT NULL DEFAULT now()
);
```
Add indexes: `idx_events_series ON events (series_ticker)`, `idx_events_status ON events (status)`, `idx_events_category ON events (category)`.

**20260216000004_extend_markets.sql** -- Add series_ticker to markets:
```sql
ALTER TABLE markets ADD COLUMN IF NOT EXISTS series_ticker TEXT;
CREATE INDEX IF NOT EXISTS idx_markets_series ON markets (series_ticker);
```

**20260216000005_update_partition_function.sql** -- Extend `create_future_partitions` to also create daily trades partitions:
Add a second loop in the function body (identical to the deltas loop) that creates `trades_YYYY_MM_DD` partitions using the same `days_ahead` parameter. Use `CREATE OR REPLACE FUNCTION` to update the existing function. The new loop should be added after the existing deltas loop and before the snapshots loop.
  </action>
  <verify>
Run `supabase db reset` or apply migrations with `supabase migration up`. Verify:
- `\dt trades*` shows parent table and daily partitions
- `\d settlements` shows all denormalized columns
- `\dt events` and `\dt series` exist
- `\d markets` shows series_ticker column
- `SELECT create_future_partitions(3, 1)` creates trades_* and deltas_* partitions
  </verify>
  <done>All 5 migration files exist, trades table is daily-partitioned with correct indexes, settlements has denormalized result/value columns, events/series tables exist with hierarchy indexes, markets has series_ticker, and partition function creates trades partitions alongside deltas.</done>
</task>

<task type="auto">
  <name>Task 2: Add Pydantic request/response models for all Phase 4 API endpoints</name>
  <files>src/api/models.py</files>
  <action>
Add new model sections to `src/api/models.py` following the existing pattern (grouped by section with comment headers).

**Trades models** (follow DeltasRequest/DeltasResponse pattern):
- `TradesRequest`: `market_ticker: str`, `start_time: datetime`, `end_time: datetime`, `cursor: str | None = None`, `limit: int = Field(default=100, ge=1, le=1000)`
- `TradeRecord`: `trade_id: str`, `market_ticker: str`, `yes_price: int` (cents), `no_price: int` (cents), `count: int`, `taker_side: str`, `ts: str` (ISO 8601)
- `TradesResponse`: `data: list[TradeRecord]`, `next_cursor: str | None`, `has_more: bool`, `request_id: str`, `response_time: float`

**Settlements models**:
- `SettlementRecord`: `market_ticker: str`, `event_ticker: str | None`, `result: str | None`, `settlement_value: int | None`, `determined_at: str | None`, `settled_at: str | None`
- `SettlementResponse`: `data: SettlementRecord`, `request_id: str`, `response_time: float`
- `SettlementsResponse`: `data: list[SettlementRecord]`, `request_id: str`, `response_time: float`

**Candles models**:
- `CandleRecord`: `bucket: str` (ISO 8601), `market_ticker: str`, `open: int`, `high: int`, `low: int`, `close: int`, `volume: int`, `trade_count: int`
- `CandlesResponse`: `data: list[CandleRecord]`, `request_id: str`, `response_time: float`

**Events/hierarchy models**:
- `EventSummary`: `event_ticker: str`, `series_ticker: str | None`, `title: str | None`, `sub_title: str | None`, `category: str | None`, `mutually_exclusive: bool | None`, `status: str | None`, `market_count: int | None = None`
- `EventDetail(EventSummary)`: `markets: list[MarketSummary]` (reuse existing MarketSummary)
- `EventsResponse`: `data: list[EventSummary]`, `request_id: str`, `response_time: float`
- `EventDetailResponse`: `data: EventDetail`, `request_id: str`, `response_time: float`
- `SeriesRecord`: `ticker: str`, `title: str | None`, `frequency: str | None`, `category: str | None`
- `SeriesResponse`: `data: list[SeriesRecord]`, `request_id: str`, `response_time: float`

All Field descriptions should match the existing style (concise, informative).
  </action>
  <verify>
Run `python -c "from src.api.models import TradesRequest, TradesResponse, SettlementRecord, CandleRecord, EventSummary, EventDetail; print('OK')"` to verify imports work without errors.
  </verify>
  <done>All Pydantic request/response models for trades, settlements, candles, and events endpoints are defined in models.py and importable without errors.</done>
</task>

</tasks>

<verification>
1. All 5 migration files exist in supabase/migrations/ with correct naming
2. Migrations apply cleanly (no syntax errors)
3. All new Pydantic models import successfully
4. Partition function updated to handle trades table
5. No existing functionality broken
</verification>

<success_criteria>
- trades table is partitioned daily with correct schema and indexes
- settlements table has denormalized columns for direct querying
- events and series tables exist for hierarchy
- markets table extended with series_ticker
- Partition function creates trades partitions
- All Phase 4 API models defined and importable
</success_criteria>

<output>
After completion, create `.planning/phases/04-backtesting-ready-api/04-01-SUMMARY.md`
</output>
