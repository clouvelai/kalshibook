---
phase: 05-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - dashboard/package.json
  - dashboard/next.config.ts
  - dashboard/tailwind.config.ts
  - dashboard/tsconfig.json
  - dashboard/middleware.ts
  - dashboard/src/app/layout.tsx
  - dashboard/src/app/(auth)/layout.tsx
  - dashboard/src/app/(auth)/login/page.tsx
  - dashboard/src/app/(auth)/signup/page.tsx
  - dashboard/src/app/(auth)/auth/callback/route.ts
  - dashboard/src/lib/supabase/client.ts
  - dashboard/src/lib/supabase/server.ts
  - dashboard/src/lib/supabase/middleware.ts
  - dashboard/src/lib/api.ts
  - dashboard/src/types/api.ts
  - dashboard/src/components/auth/login-form.tsx
  - dashboard/src/components/auth/signup-form.tsx
  - dashboard/.env.local.example
autonomous: true

must_haves:
  truths:
    - "Next.js 15 app runs on port 3000 and proxies /api/* requests to FastAPI on port 8000"
    - "Unauthenticated users are redirected to /login"
    - "User can sign up with email/password and is redirected to dashboard"
    - "User can log in with email/password and is redirected to dashboard"
    - "Google OAuth login redirects through Supabase and returns to dashboard via /auth/callback"
    - "Auth tokens are stored in httpOnly cookies and refreshed by middleware"
  artifacts:
    - path: "dashboard/package.json"
      provides: "Next.js project with all dependencies"
      contains: "next"
    - path: "dashboard/middleware.ts"
      provides: "Supabase auth middleware with token refresh"
      contains: "getUser"
    - path: "dashboard/src/lib/api.ts"
      provides: "Typed API client for FastAPI backend"
      contains: "fetchAPI"
    - path: "dashboard/src/app/(auth)/login/page.tsx"
      provides: "Login page"
      contains: "login"
    - path: "dashboard/src/app/(auth)/signup/page.tsx"
      provides: "Signup page"
      contains: "signup"
    - path: "dashboard/src/app/(auth)/auth/callback/route.ts"
      provides: "OAuth callback handler"
      contains: "exchangeCodeForSession"
  key_links:
    - from: "dashboard/middleware.ts"
      to: "dashboard/src/lib/supabase/middleware.ts"
      via: "updateSession import"
      pattern: "updateSession"
    - from: "dashboard/src/lib/api.ts"
      to: "http://localhost:8000"
      via: "next.config.ts rewrites proxy"
      pattern: "fetchAPI.*api"
    - from: "dashboard/src/components/auth/login-form.tsx"
      to: "dashboard/src/lib/supabase/client.ts"
      via: "signInWithPassword"
      pattern: "signInWithPassword"
    - from: "dashboard/src/app/(auth)/auth/callback/route.ts"
      to: "dashboard/src/lib/supabase/server.ts"
      via: "exchangeCodeForSession"
      pattern: "exchangeCodeForSession"
---

<objective>
Scaffold the Next.js 15 dashboard app with Supabase SSR auth, API proxy configuration, and complete login/signup pages (email/password + Google OAuth).

Purpose: Establishes the entire frontend foundation -- project structure, auth flow, API client, and entry pages. All subsequent dashboard plans build on this.

Output: Working Next.js app with auth pages, Supabase middleware, and typed API client.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-dashboard/05-RESEARCH.md
@.planning/phases/05-dashboard/05-CONTEXT.md
@.planning/phases/05-dashboard/05-01-SUMMARY.md
@src/api/models.py
@src/api/routes/keys.py
@src/api/routes/billing.py
@src/api/routes/auth.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Next.js 15 project with Supabase SSR auth</name>
  <files>
    dashboard/package.json
    dashboard/next.config.ts
    dashboard/middleware.ts
    dashboard/src/lib/supabase/client.ts
    dashboard/src/lib/supabase/server.ts
    dashboard/src/lib/supabase/middleware.ts
    dashboard/src/lib/api.ts
    dashboard/src/types/api.ts
    dashboard/src/app/layout.tsx
    dashboard/.env.local.example
  </files>
  <action>
    1. Run `npx create-next-app@15 dashboard --typescript --tailwind --eslint --app --src-dir --use-npm` from the project root. Accept defaults (no Turbopack for stability).

    2. Install dependencies:
       ```bash
       cd dashboard
       npx shadcn@latest init  # Accept defaults: New York style, Zinc base color, CSS variables
       npx shadcn@latest add sidebar table progress dialog button card input label badge switch alert-dialog dropdown-menu separator skeleton toast
       npm install @supabase/supabase-js @supabase/ssr @tanstack/react-table lucide-react sonner
       ```

    3. Create `dashboard/next.config.ts` with rewrites to proxy `/api/*` to `http://localhost:8000/:path*` (FastAPI backend). This eliminates CORS issues.

    4. Create Supabase client files per @supabase/ssr docs:
       - `src/lib/supabase/client.ts`: Browser client using `createBrowserClient` from `@supabase/ssr` with `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY`.
       - `src/lib/supabase/server.ts`: Server client using `createServerClient` from `@supabase/ssr` with `cookies()` from `next/headers`. Uses `getAll`/`setAll` cookie methods.
       - `src/lib/supabase/middleware.ts`: Export `updateSession(request)` function that creates a Supabase server client, calls `getUser()` to trigger token refresh, and redirects unauthenticated users to `/login` (except for `/login`, `/signup`, `/auth` paths and static assets).

    5. Create `dashboard/middleware.ts` (root level) that imports and calls `updateSession` from `src/lib/supabase/middleware.ts`. Matcher config: `["/((?!_next/static|_next/image|favicon.ico).*)"]`.

    6. Create `src/lib/api.ts` -- typed fetch wrapper for the FastAPI backend:
       - `fetchAPI<T>(path, options)`: Gets Supabase session, adds `Authorization: Bearer ${access_token}` header, prepends `/api` base path (proxied to FastAPI), returns typed JSON response. Throws on non-OK responses.
       - Export `api` object with namespaced methods matching the FastAPI endpoints:
         - `api.keys.list()`, `api.keys.create(name, keyType)`, `api.keys.revoke(keyId)`, `api.keys.usage()`
         - `api.billing.status()`, `api.billing.togglePayg(enable)`, `api.billing.createCheckout()`, `api.billing.createPortal()`
         - `api.auth.signup(email, password)`, `api.auth.login(email, password)`

    7. Create `src/types/api.ts` with TypeScript interfaces matching FastAPI response models:
       - `ApiKeyInfo`: id, name, key_prefix, key_type, created_at, last_used_at
       - `ApiKeyCreated`: id, key, name, key_prefix, key_type, created_at
       - `KeyUsageItem`: id, name, key_prefix, key_type, created_at, last_used_at, credits_used
       - `BillingStatus`: tier, credits_total, credits_used, credits_remaining, payg_enabled, billing_cycle_start
       - `AuthResponse`: access_token, refresh_token, user_id, request_id

    8. Update `src/app/layout.tsx`: Set metadata title to "KalshiBook Dashboard", description to "Manage your API keys, usage, and billing". Add Toaster from sonner.

    9. Create `dashboard/.env.local.example`:
       ```
       NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
       NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=<your-supabase-anon-key>
       ```
  </action>
  <verify>
    - `cd dashboard && npm run build` completes without errors
    - `npm run dev` starts on port 3000
    - Visiting http://localhost:3000 redirects to /login (middleware working)
  </verify>
  <done>
    - Next.js 15 app with shadcn/ui, Tailwind, and all dependencies installed
    - Supabase SSR auth middleware redirects unauthenticated users to /login
    - API client proxies through Next.js rewrites to FastAPI
    - TypeScript types match FastAPI models
  </done>
</task>

<task type="auto">
  <name>Task 2: Build login, signup, and OAuth callback pages</name>
  <files>
    dashboard/src/app/(auth)/layout.tsx
    dashboard/src/app/(auth)/login/page.tsx
    dashboard/src/app/(auth)/signup/page.tsx
    dashboard/src/app/(auth)/auth/callback/route.ts
    dashboard/src/components/auth/login-form.tsx
    dashboard/src/components/auth/signup-form.tsx
  </files>
  <action>
    1. Create `src/app/(auth)/layout.tsx`:
       - Centered card layout: `flex min-h-screen items-center justify-center bg-gray-50`.
       - Wraps children in a `max-w-md` container.
       - NO sidebar (auth pages are outside the dashboard layout).

    2. Create `src/components/auth/login-form.tsx` ("use client"):
       - Email and password input fields using shadcn Input + Label components.
       - "Sign in" button using shadcn Button.
       - Google OAuth button: "Continue with Google" with Google icon (from lucide-react or inline SVG).
       - Form submission handler:
         a. Email/password: Call Supabase `signInWithPassword({ email, password })` via the browser client. On success, `router.push("/")`. On error, show error message in a red text block.
         b. Google: Call `signInWithOAuth({ provider: "google", options: { redirectTo: `${window.location.origin}/auth/callback` } })`.
       - Link to signup page: "Don't have an account? Sign up"
       - Display error from URL params (e.g., `?error=auth_failed` from OAuth callback).
       - KalshiBook branding: Show "KalshiBook" text/logo above the form with a subtle tagline "Prediction market data API".

    3. Create `src/components/auth/signup-form.tsx` ("use client"):
       - Email, password, and confirm password fields.
       - "Create account" button.
       - Google OAuth button (same as login).
       - Form submission handler:
         a. Validate password match client-side.
         b. Call the FastAPI signup endpoint via `api.auth.signup(email, password)` to get tokens AND trigger default key creation (per Plan 05-01).
         c. Then call Supabase `signInWithPassword` with the same credentials to establish the browser session.
         d. On success, `router.push("/")`.
       - Link to login page: "Already have an account? Sign in"
       - KalshiBook branding matching login page.

    4. Create `src/app/(auth)/login/page.tsx`:
       - Server component that renders `<LoginForm />`.
       - Metadata: title "Sign in — KalshiBook".

    5. Create `src/app/(auth)/signup/page.tsx`:
       - Server component that renders `<SignupForm />`.
       - Metadata: title "Create account — KalshiBook".

    6. Create `src/app/(auth)/auth/callback/route.ts`:
       - GET handler for OAuth callback.
       - Extracts `code` from URL search params.
       - Creates a Supabase server client using `cookies()`.
       - Calls `supabase.auth.exchangeCodeForSession(code)`.
       - On success, redirects to `/` (dashboard root).
       - On error, redirects to `/login?error=auth_failed`.

    Visual style per user decisions: clean white background, rounded cards, professional feel matching Tavily's aesthetic. Use shadcn Card component for the auth forms. Light theme only.
  </action>
  <verify>
    - `cd dashboard && npm run build` completes without errors
    - Visiting /login shows the login form with email/password fields and Google OAuth button
    - Visiting /signup shows the signup form
    - Submitting login with valid Supabase credentials redirects to /
    - /auth/callback route exists and handles OAuth code exchange
  </verify>
  <done>
    - Login page with email/password + Google OAuth
    - Signup page with email/password + Google OAuth
    - OAuth callback route exchanges code for session
    - Auth layout is centered card style with KalshiBook branding
    - Links between login and signup pages work
  </done>
</task>

</tasks>

<verification>
- `npm run build` in dashboard/ succeeds
- Unauthenticated visit to / redirects to /login
- Login with valid email/password redirects to / (authenticated)
- Google OAuth button initiates Supabase OAuth flow
- /auth/callback handles the OAuth return
- API client methods are typed and callable
</verification>

<success_criteria>
Complete Next.js 15 app with working auth flow (email/password + Google OAuth), Supabase SSR middleware, and typed API client ready for dashboard pages.
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard/05-02-SUMMARY.md`
</output>
