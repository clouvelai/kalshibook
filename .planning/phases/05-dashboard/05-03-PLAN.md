---
phase: 05-dashboard
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - dashboard/src/app/(dashboard)/layout.tsx
  - dashboard/src/app/(dashboard)/page.tsx
  - dashboard/src/components/sidebar/app-sidebar.tsx
  - dashboard/src/components/billing/usage-bar.tsx
  - dashboard/src/components/billing/payg-toggle.tsx
  - dashboard/src/components/keys/keys-table.tsx
  - dashboard/src/components/keys/create-key-dialog.tsx
  - dashboard/src/components/keys/revoke-key-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard has a left sidebar with navigation links for Overview, API Keys, Billing, and Documentation (external link)"
    - "Overview page shows a credit usage progress bar with credits used / credits available"
    - "Overview page has a PAYG toggle that calls POST /billing/payg"
    - "Overview page shows a summary keys table with per-key usage"
  artifacts:
    - path: "dashboard/src/app/(dashboard)/layout.tsx"
      provides: "Dashboard layout with sidebar"
      contains: "SidebarProvider"
    - path: "dashboard/src/components/sidebar/app-sidebar.tsx"
      provides: "Left sidebar navigation"
      contains: "Sidebar"
    - path: "dashboard/src/components/billing/usage-bar.tsx"
      provides: "Credit usage progress bar"
      contains: "Progress"
    - path: "dashboard/src/components/billing/payg-toggle.tsx"
      provides: "PAYG toggle switch"
      contains: "Switch"
    - path: "dashboard/src/app/(dashboard)/page.tsx"
      provides: "Overview landing page"
      contains: "UsageBar"
  key_links:
    - from: "dashboard/src/app/(dashboard)/layout.tsx"
      to: "dashboard/src/components/sidebar/app-sidebar.tsx"
      via: "AppSidebar component import"
      pattern: "AppSidebar"
    - from: "dashboard/src/app/(dashboard)/page.tsx"
      to: "dashboard/src/lib/api.ts"
      via: "api.billing.status() and api.keys.usage() calls"
      pattern: "api\\.billing\\.status|api\\.keys\\.usage"
    - from: "dashboard/src/components/billing/payg-toggle.tsx"
      to: "dashboard/src/lib/api.ts"
      via: "api.billing.togglePayg() call"
      pattern: "togglePayg"
---

<objective>
Build the dashboard layout with left sidebar navigation and the Overview landing page with usage bar, PAYG toggle, and keys summary table.

Purpose: The Overview page is the user's first view after login -- it shows everything at a glance. The sidebar provides navigation to all dashboard sections.

Output: Dashboard layout with sidebar, Overview page with usage bar, PAYG toggle, and keys summary.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-dashboard/05-RESEARCH.md
@.planning/phases/05-dashboard/05-CONTEXT.md
@.planning/phases/05-dashboard/05-02-SUMMARY.md
@dashboard/src/lib/api.ts
@dashboard/src/types/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dashboard layout with left sidebar navigation</name>
  <files>
    dashboard/src/app/(dashboard)/layout.tsx
    dashboard/src/components/sidebar/app-sidebar.tsx
  </files>
  <action>
    1. Create `src/components/sidebar/app-sidebar.tsx` ("use client"):
       - Use shadcn/ui Sidebar component with SidebarContent, SidebarGroup, SidebarGroupContent, SidebarMenu, SidebarMenuItem, SidebarMenuButton.
       - Navigation items (per user decisions):
         a. **Overview** — icon: LayoutDashboard (lucide-react), href: "/"
         b. **API Keys** — icon: Key (lucide-react), href: "/keys"
         c. **Billing** — icon: CreditCard (lucide-react), href: "/billing"
         d. **Documentation** — icon: ExternalLink (lucide-react), href: the FastAPI docs URL or "/llms.txt" — opens in new tab (target="_blank")
       - Active state: highlight the current route using `usePathname()` from `next/navigation`.
       - At the top of the sidebar: KalshiBook logo/text with a subtle "Dashboard" label.
       - At the bottom of the sidebar: User email display and a "Sign out" button that calls `supabase.auth.signOut()` then `router.push("/login")`.
       - Style: match Tavily's sidebar aesthetic — clean white/light background, subtle borders, professional feel, rounded menu items on hover.

    2. Create `src/app/(dashboard)/layout.tsx`:
       - Server component (or client component if needed for SidebarProvider).
       - Wrap children in `<SidebarProvider>` with `<AppSidebar />` and a `<main className="flex-1 overflow-auto">` for page content.
       - Add padding to main content area: `p-6` or `p-8`.
       - Check auth: use the Supabase server client to get the user. If not authenticated, redirect to /login (defense in depth alongside middleware).
       - Pass user email to AppSidebar for the bottom user display.

    Note: The (dashboard) route group means all pages under it share this sidebar layout without affecting URLs. "/" maps to the overview, "/keys" to keys, "/billing" to billing.
  </action>
  <verify>
    - `cd dashboard && npm run build` completes without errors
    - Visiting / (when authenticated) shows the sidebar with Overview, API Keys, Billing, Documentation links
    - Clicking sidebar links navigates between pages
    - Sign out button redirects to /login
  </verify>
  <done>
    - Left sidebar navigation with Overview, API Keys, Billing, Documentation links
    - Active route is highlighted in the sidebar
    - User email shown at bottom with sign out button
    - Sidebar matches Tavily's clean professional aesthetic
  </done>
</task>

<task type="auto">
  <name>Task 2: Overview page with usage bar, PAYG toggle, and keys summary</name>
  <files>
    dashboard/src/app/(dashboard)/page.tsx
    dashboard/src/components/billing/usage-bar.tsx
    dashboard/src/components/billing/payg-toggle.tsx
    dashboard/src/components/keys/keys-table.tsx
  </files>
  <action>
    1. Create `src/components/billing/usage-bar.tsx` ("use client"):
       - Props: `creditsUsed: number, creditsTotal: number, tier: string`.
       - Use shadcn Card with CardHeader + CardContent.
       - CardHeader shows "API Usage — {Tier} Plan" in muted text.
       - CardContent: shadcn Progress bar (percentage = creditsUsed/creditsTotal * 100, capped at 100%).
       - Below the bar: flex row with "X credits used" on the left, "Y remaining" on the right, muted text.
       - Format numbers with toLocaleString() for readability (e.g., "1,000").

    2. Create `src/components/billing/payg-toggle.tsx` ("use client"):
       - Props: `initialEnabled: boolean, onToggle: (enabled: boolean) => Promise<void>`.
       - Use shadcn Switch component.
       - Label: "Pay-As-You-Go" with description text: "Continue using the API after credits run out ($0.008/credit)."
       - On toggle: call `api.billing.togglePayg(newValue)`. Show sonner toast on success/error.
       - Wrap in a shadcn Card for consistent styling.

    3. Create `src/components/keys/keys-table.tsx` ("use client"):
       - Props: `keys: KeyUsageItem[]` (from api.ts types).
       - Simple shadcn Table (no TanStack for the overview summary -- keep it lightweight).
       - Columns: Name, Type (badge), Usage (credits_used), Key (key_prefix masked as "kb-xxxx..."), Last Used.
       - Type column: shadcn Badge with variant based on key_type ("dev" = default/outline, "prod" = secondary).
       - No create/edit/delete actions on the overview page -- that's the API Keys page.
       - If no keys exist (shouldn't happen with auto-provisioning, but handle it): show a message "No API keys found" with a link to /keys to create one.

    4. Create `src/app/(dashboard)/page.tsx` ("use client"):
       - This is the Overview landing page (user decision: overview is the landing page).
       - On mount, fetch data in parallel:
         a. `api.billing.status()` for usage bar data
         b. `api.keys.usage()` for keys table data
       - Lazy init check: if `api.keys.usage()` returns empty data array, call `api.keys.create("default", "dev")` to create the default key, then re-fetch. This handles Google OAuth users who didn't go through POST /auth/signup.
       - Layout: page title "Overview" at the top, then:
         a. Usage bar card (full width)
         b. PAYG toggle card (full width, below usage bar)
         c. "API Keys" section header with keys table (full width)
       - Loading state: show shadcn Skeleton components while data loads.
       - Error state: show error message with retry button if API calls fail.
       - Style: clean white background, rounded cards, subtle shadows, matching Tavily's aesthetic. Use `space-y-6` for vertical spacing between sections.
  </action>
  <verify>
    - `cd dashboard && npm run build` completes without errors
    - Visiting / (authenticated) shows usage bar, PAYG toggle, and keys table
    - Usage bar shows correct credit usage from billing status
    - PAYG toggle calls the backend and shows toast feedback
    - Keys table displays key name, type badge, usage, masked key prefix
    - Loading skeletons appear before data loads
  </verify>
  <done>
    - Overview page shows credit usage progress bar with correct data
    - PAYG toggle works and provides feedback via toast
    - Keys summary table shows per-key usage data
    - Lazy init creates default key for OAuth users with no keys
    - Loading and error states handled gracefully
  </done>
</task>

</tasks>

<verification>
- Dashboard layout renders with sidebar navigation
- Overview page loads billing status and keys usage data from the backend
- PAYG toggle calls POST /billing/payg successfully
- Sidebar links navigate correctly (Overview active by default)
- Sign out clears auth and redirects to /login
</verification>

<success_criteria>
User logs in and sees a professional dashboard with sidebar navigation, credit usage bar, PAYG toggle, and their API keys summarized with per-key usage -- all pulling live data from the FastAPI backend.
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard/05-03-SUMMARY.md`
</output>
