---
phase: 05-dashboard
plan: 04
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - dashboard/src/app/(dashboard)/keys/page.tsx
  - dashboard/src/app/(dashboard)/billing/page.tsx
  - dashboard/src/components/keys/create-key-dialog.tsx
  - dashboard/src/components/keys/revoke-key-dialog.tsx
  - dashboard/src/components/keys/keys-management-table.tsx
  - dashboard/src/components/billing/plan-card.tsx
autonomous: true

must_haves:
  truths:
    - "User can view all their API keys in a table with Name, Type, Usage, Key (masked), and Options columns"
    - "User can create a new named API key and sees the full raw key in a copy-able modal (show-once)"
    - "User can revoke an API key after confirmation dialog"
    - "Billing page shows current plan info, next billing date, and a Manage in Stripe button"
  artifacts:
    - path: "dashboard/src/app/(dashboard)/keys/page.tsx"
      provides: "API Keys management page"
      contains: "KeysManagementTable"
    - path: "dashboard/src/app/(dashboard)/billing/page.tsx"
      provides: "Billing management page"
      contains: "PlanCard"
    - path: "dashboard/src/components/keys/create-key-dialog.tsx"
      provides: "Create key dialog with show-once modal"
      contains: "Dialog"
    - path: "dashboard/src/components/keys/revoke-key-dialog.tsx"
      provides: "Revoke confirmation dialog"
      contains: "AlertDialog"
    - path: "dashboard/src/components/keys/keys-management-table.tsx"
      provides: "Full CRUD keys table"
      contains: "Table"
    - path: "dashboard/src/components/billing/plan-card.tsx"
      provides: "Plan info card with Stripe portal link"
      contains: "createPortal"
  key_links:
    - from: "dashboard/src/app/(dashboard)/keys/page.tsx"
      to: "dashboard/src/lib/api.ts"
      via: "api.keys.usage() and api.keys.create/revoke calls"
      pattern: "api\\.keys"
    - from: "dashboard/src/components/keys/create-key-dialog.tsx"
      to: "dashboard/src/lib/api.ts"
      via: "api.keys.create() call"
      pattern: "api\\.keys\\.create"
    - from: "dashboard/src/components/keys/revoke-key-dialog.tsx"
      to: "dashboard/src/lib/api.ts"
      via: "api.keys.revoke() call"
      pattern: "api\\.keys\\.revoke"
    - from: "dashboard/src/components/billing/plan-card.tsx"
      to: "dashboard/src/lib/api.ts"
      via: "api.billing.createPortal() call"
      pattern: "createPortal"
---

<objective>
Build the API Keys management page with full CRUD (create with show-once modal, revoke with confirmation) and the Billing page with plan info and Stripe portal link.

Purpose: These are the two remaining dashboard pages. The Keys page lets users manage their API keys with per-key usage visibility. The Billing page gives access to Stripe subscription management.

Output: API Keys page with create/revoke dialogs, Billing page with plan card and Stripe portal link.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-dashboard/05-RESEARCH.md
@.planning/phases/05-dashboard/05-CONTEXT.md
@.planning/phases/05-dashboard/05-02-SUMMARY.md
@dashboard/src/lib/api.ts
@dashboard/src/types/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: API Keys management page with create and revoke dialogs</name>
  <files>
    dashboard/src/app/(dashboard)/keys/page.tsx
    dashboard/src/components/keys/create-key-dialog.tsx
    dashboard/src/components/keys/revoke-key-dialog.tsx
    dashboard/src/components/keys/keys-management-table.tsx
  </files>
  <action>
    1. Create `src/components/keys/create-key-dialog.tsx` ("use client"):
       - Two-phase dialog using shadcn Dialog:
         **Phase 1 — Create form:**
         - Text input for key name (required, placeholder: "e.g., production, testing").
         - Select/dropdown for key type: "Development" (dev) or "Production" (prod). Default: dev.
         - "Create Key" button.
         - On submit: call `api.keys.create(name, keyType)`. On success, transition to Phase 2.
         **Phase 2 — Show-once key display:**
         - Warning text: "Your API key has been created. Copy it now — you won't be able to see it again."
         - Display the full raw key in a monospace, bordered box.
         - "Copy" button that copies the key to clipboard using `navigator.clipboard.writeText()` and shows a sonner toast "API key copied to clipboard".
         - "Done" button that closes the dialog, clears the key from state, and calls `onKeyCreated()` callback to refresh the parent table.
       - The raw key is ONLY in component state during Phase 2. Once dialog closes, it's gone.

    2. Create `src/components/keys/revoke-key-dialog.tsx` ("use client"):
       - Use shadcn AlertDialog (destructive action pattern).
       - Props: `keyName: string, keyId: string, onRevoked: () => void`.
       - Title: "Revoke API Key"
       - Description: 'Are you sure you want to revoke "{keyName}"? This key will stop working immediately.'
       - Actions: "Cancel" and "Revoke" (destructive variant).
       - On confirm: call `api.keys.revoke(keyId)`. Show sonner toast "API key revoked". Call `onRevoked()`.

    3. Create `src/components/keys/keys-management-table.tsx` ("use client"):
       - Props: `keys: KeyUsageItem[], onRefresh: () => void`.
       - Full table with columns per user decisions: Name, Type, Usage (credits_used), Key (masked key_prefix + "..."), Options.
       - Type column: shadcn Badge ("dev" = outline variant, "prod" = secondary variant).
       - Key column: show `key_prefix` + "..." (already masked from backend). No unmask option (show-once pattern).
       - Options column: shadcn DropdownMenu with:
         a. "Copy key prefix" — copies the key_prefix to clipboard (for reference only).
         b. "Revoke" — opens RevokeKeyDialog.
       - No edit action (key name is set at creation and doesn't change to keep it simple).
       - Sort by created_at descending (newest first, matching backend order).

    4. Create `src/app/(dashboard)/keys/page.tsx` ("use client"):
       - Page title: "API Keys" with description "Manage your API keys for accessing KalshiBook data endpoints."
       - "Create Key" button (top right) opens CreateKeyDialog.
       - On mount: fetch `api.keys.usage()` for the keys table with per-key usage.
       - Render KeysManagementTable with the fetched data.
       - Loading state: Skeleton table rows.
       - Empty state: Card with message "No API keys yet" and a "Create your first key" button.
       - `onRefresh` callback re-fetches keys after create/revoke.
  </action>
  <verify>
    - `cd dashboard && npm run build` completes without errors
    - Visiting /keys shows the keys management table with existing keys
    - Clicking "Create Key" opens the dialog, entering a name and clicking create shows the raw key
    - Copying the key shows a toast notification
    - Closing the create dialog and the raw key is no longer accessible
    - Clicking "Revoke" in the dropdown opens confirmation dialog
    - Confirming revoke removes the key from the table
  </verify>
  <done>
    - Keys page shows table with Name, Type, Usage, Key (masked), Options columns
    - Create key dialog with name input, type selector, and show-once key display
    - Revoke key dialog with confirmation before deletion
    - Table refreshes after create/revoke operations
    - Loading and empty states handled
  </done>
</task>

<task type="auto">
  <name>Task 2: Billing page with plan info and Stripe portal link</name>
  <files>
    dashboard/src/app/(dashboard)/billing/page.tsx
    dashboard/src/components/billing/plan-card.tsx
  </files>
  <action>
    1. Create `src/components/billing/plan-card.tsx` ("use client"):
       - Props: `tier: string, creditsTotal: number, creditsUsed: number, creditsRemaining: number, payg_enabled: boolean, billingCycleStart: string`.
       - Use shadcn Card.
       - Display:
         a. **Current Plan**: capitalize tier name (Free / Project), with badge.
         b. **Credits**: "{creditsUsed} / {creditsTotal} used" with progress bar (reuse UsageBar pattern or inline).
         c. **Next billing date**: Calculate from billingCycleStart + 1 month, format as readable date.
         d. **Pay-As-You-Go**: Status badge (Enabled/Disabled).
         e. **Manage in Stripe** button: calls `api.billing.createPortal()`, then `window.location.href = portal_url` to redirect to Stripe Customer Portal. Disabled if no Stripe customer (free tier without PAYG).
         f. **Upgrade** button (only if tier is "free"): calls `api.billing.createCheckout()`, then `window.location.href = checkout_url`. Label: "Upgrade to Project Plan — $30/mo".
       - Handle loading state during Stripe redirect.

    2. Create `src/app/(dashboard)/billing/page.tsx` ("use client"):
       - Page title: "Billing" with description "Manage your subscription and payment methods."
       - On mount: fetch `api.billing.status()`.
       - Render PlanCard with the billing status data.
       - Handle `?success=true` and `?canceled=true` URL params (from Stripe redirect):
         a. `success=true`: Show sonner toast "Subscription activated! Your credits have been updated."
         b. `canceled=true`: Show sonner toast "Checkout canceled." (info variant, not error).
       - Loading state: Skeleton card.
       - Error state: Error card with retry button.
       - Style: consistent with other pages — clean cards, professional spacing.
  </action>
  <verify>
    - `cd dashboard && npm run build` completes without errors
    - Visiting /billing shows plan info card with current tier, credits, and dates
    - "Manage in Stripe" button redirects to Stripe Customer Portal (with test mode Stripe)
    - "Upgrade" button appears for free tier users and redirects to Stripe Checkout
    - Success/canceled URL params trigger appropriate toast messages
  </verify>
  <done>
    - Billing page displays current plan, credit usage, billing cycle date
    - Stripe Customer Portal accessible via "Manage in Stripe" button
    - Upgrade button visible for free tier users linking to Stripe Checkout
    - Stripe return URL params handled with appropriate toasts
  </done>
</task>

</tasks>

<verification>
- API Keys page: full CRUD workflow (create with name + type, view in table, revoke with confirmation)
- Show-once key pattern: raw key visible only in creation modal, never again
- Billing page: plan info, credit usage, Stripe portal link, upgrade option
- All API calls hit the FastAPI backend via the Next.js proxy
- Error and loading states are handled on both pages
</verification>

<success_criteria>
User can fully manage their API keys (create named keys, see per-key usage, revoke keys) and access Stripe billing management (view plan, manage subscription, upgrade) from the dashboard.
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard/05-04-SUMMARY.md`
</output>
