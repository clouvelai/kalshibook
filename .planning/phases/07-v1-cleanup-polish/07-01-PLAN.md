---
phase: 07-v1-cleanup-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dashboard/src/components/playground/use-playground.ts
  - dashboard/src/components/playground/playground-form.tsx
  - dashboard/src/app/(dashboard)/playground/page.tsx
  - dashboard/src/types/api.ts
  - src/api/models.py
  - dashboard/src/components/billing/payg-toggle.tsx
  - .planning/REQUIREMENTS.md
autonomous: true

must_haves:
  truths:
    - "Submitting playground form without timestamp shows validation error instead of raw 422"
    - "Timestamp field is visible as a required field (not hidden under accordion)"
    - "PaygToggle component file no longer exists in the codebase"
    - "SeriesRecord and SeriesResponse classes no longer exist in models.py"
    - "REQUIREMENTS.md includes BKTS-01 through BKTS-04 with Complete status"
    - "All traceability table entries show Complete status (not Pending)"
  artifacts:
    - path: "dashboard/src/components/playground/use-playground.ts"
      provides: "Timestamp validation in sendRequest before API call"
      contains: "Timestamp is required"
    - path: "dashboard/src/components/playground/playground-form.tsx"
      provides: "Timestamp promoted to visible required field with asterisk indicator"
      contains: "text-destructive"
    - path: "dashboard/src/app/(dashboard)/playground/page.tsx"
      provides: "requestError rendered in the page"
      contains: "requestError"
    - path: ".planning/REQUIREMENTS.md"
      provides: "Complete traceability with BKTS section and updated statuses"
      contains: "BKTS-01"
  key_links:
    - from: "dashboard/src/components/playground/use-playground.ts"
      to: "dashboard/src/components/playground/playground-form.tsx"
      via: "canSend guard includes timestamp check"
      pattern: "timestamp\\.trim\\(\\)"
    - from: "dashboard/src/app/(dashboard)/playground/page.tsx"
      to: "dashboard/src/components/playground/use-playground.ts"
      via: "playground.requestError rendered conditionally"
      pattern: "playground\\.requestError"
---

<objective>
Close all v1 milestone audit gaps: add client-side timestamp validation to the API Playground, remove orphaned dead code (PaygToggle component + SeriesRecord/SeriesResponse models), and update REQUIREMENTS.md traceability to reflect completed phases.

Purpose: Eliminate known tech debt and documentation staleness before v1 is considered shippable. Every change makes the codebase simpler or more accurate -- no new features.
Output: Clean playground UX, zero orphaned code, accurate requirements traceability.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-v1-cleanup-polish/07-RESEARCH.md

@dashboard/src/components/playground/use-playground.ts
@dashboard/src/components/playground/playground-form.tsx
@dashboard/src/app/(dashboard)/playground/page.tsx
@dashboard/src/types/api.ts
@src/api/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add client-side timestamp validation and promote field to required</name>
  <files>
    dashboard/src/components/playground/use-playground.ts
    dashboard/src/components/playground/playground-form.tsx
    dashboard/src/app/(dashboard)/playground/page.tsx
    dashboard/src/types/api.ts
  </files>
  <action>
    **use-playground.ts** -- Add timestamp validation in `sendRequest()`:
    - After the existing `if (!revealedKey)` guard (line 218), add a new guard:
      ```
      if (!timestamp.trim()) {
        setRequestError("Timestamp is required. Enter an ISO 8601 timestamp (e.g., 2025-02-14T18:00:00Z).");
        return;
      }
      ```
    - In `setField` callback, clear requestError when user types (standard form UX to remove stale errors):
      Add `setRequestError(null);` as the first line inside the `setField` useCallback body (before the switch statement).
    - In `sendRequest()`, change the timestamp body assignment from conditional to always-included:
      Replace `if (timestamp) body.timestamp = timestamp;` with `body.timestamp = timestamp;` (validation above guarantees it's non-empty).

    **playground-form.tsx** -- Promote timestamp to visible required field:
    - Update `canSend` guard (line 58) to include timestamp: `const canSend = !!revealedKey && !!marketTicker.trim() && !!timestamp.trim() && !isLoading;`
    - Move the Timestamp `<div className="space-y-2">` block OUT of the `{additionalOpen && ...}` section and place it immediately after the Market Ticker block (before the "Additional fields" toggle).
    - Add the required asterisk to the Timestamp label: `Timestamp (ISO 8601) <span className="text-destructive">*</span>`
    - Remove the Timestamp block from inside the accordion. The accordion should now only contain the Depth field.

    **page.tsx** -- Render requestError:
    - Add `requestError` display between the left panel `PlaygroundForm` and the right panel `CodePanel`. Place it inside the `<div className="flex flex-col lg:flex-row gap-6">` wrapper, right after the form's closing `</div>`:
      ```tsx
      {playground.requestError && (
        <p className="text-sm text-destructive">{playground.requestError}</p>
      )}
      ```

    **types/api.ts** -- Fix TypeScript type to match backend:
    - Change `OrderbookRequest.timestamp` from `timestamp?: string` to `timestamp: string` (line 74). The backend requires this field (no default on the Pydantic model).

    **Do NOT:**
    - Add a form validation library (zod, react-hook-form) -- a simple string check is sufficient for one field.
    - Remove the `PaygToggleResponse` type or `api.billing.togglePayg()` -- those are NOT dead code.
    - Break the "Try an example" button -- `fillExample()` already sets timestamp to `"2025-02-14T18:00:00Z"`, so validation will pass.
  </action>
  <verify>
    Run `cd dashboard && npx next build` -- should compile with no TypeScript errors. Visually confirm in browser: timestamp field visible without clicking accordion, required asterisk shown, submitting without timestamp shows inline error, "Try an example" still fills all fields and allows send.
  </verify>
  <done>
    Playground form shows Timestamp as a visible required field with asterisk. Submitting without timestamp shows "Timestamp is required..." error instead of raw 422. Error clears when user starts typing. canSend button is disabled when timestamp is empty. TypeScript OrderbookRequest type matches backend (timestamp is required). "Try an example" flow still works.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove orphaned dead code (PaygToggle component + Series models)</name>
  <files>
    dashboard/src/components/billing/payg-toggle.tsx
    src/api/models.py
  </files>
  <action>
    **Delete file:** `dashboard/src/components/billing/payg-toggle.tsx`
    - This component is never imported anywhere. The PAYG toggle functionality is implemented inline in `dashboard/src/components/billing/usage-bar.tsx`.
    - Verify before deletion: `grep -r "payg-toggle" dashboard/src/` and `grep -r "PaygToggle" dashboard/src/` should return only the file itself (no imports).

    **Remove from `src/api/models.py`:** Delete the `SeriesRecord` and `SeriesResponse` classes (lines 401-415).
    - These models are defined but never imported by any route in `src/api/routes/`.
    - Verify before removal: `grep -r "SeriesRecord\|SeriesResponse" src/api/` should return only the definitions in `models.py` (no imports).
    - Leave the rest of `models.py` untouched. The `ErrorDetail` class that follows (line 418+) must remain.

    **Do NOT remove:**
    - `PaygToggleResponse` in `dashboard/src/types/api.ts` -- actively used by `api.billing.togglePayg()` in `lib/api.ts`
    - `api.billing.togglePayg()` in `dashboard/src/lib/api.ts` -- actively used by `UsageBar` component
    - The `series` database table or any migration files
    - Any code in `src/collector/writer.py` that writes to the series table
  </action>
  <verify>
    Run `ls dashboard/src/components/billing/payg-toggle.tsx` -- should return "No such file". Run `grep -c "SeriesRecord\|SeriesResponse" src/api/models.py` -- should return 0. Run `cd dashboard && npx next build` and verify no import errors. Run `python -c "from src.api.models import ErrorDetail; print('OK')"` to confirm models.py still parses correctly.
  </verify>
  <done>
    `payg-toggle.tsx` file deleted. `SeriesRecord` and `SeriesResponse` classes removed from `models.py`. No build errors in dashboard. No import errors in backend. `ErrorDetail` and all other models still present and functional.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update REQUIREMENTS.md traceability to reflect completed v1</name>
  <files>
    .planning/REQUIREMENTS.md
  </files>
  <action>
    Update `.planning/REQUIREMENTS.md` with the following changes:

    **1. Add Backtesting section** under v1 Requirements, after the "Developer Experience" section and before "Dashboard":
    ```markdown
    ### Backtesting

    - [x] **BKTS-01**: Collector captures public trade executions and trade history is queryable via API
    - [x] **BKTS-02**: Settlement/resolution data normalized and queryable
    - [x] **BKTS-03**: Candlestick data available at 1m, 1h, 1d intervals
    - [x] **BKTS-04**: Event/market hierarchy exposed via API
    ```

    **2. Mark all v1 requirements as complete:** Change every `- [ ]` to `- [x]` in the v1 Requirements section (Data Collection, Data Serving, Authentication, Billing, Developer Experience, Dashboard).

    **3. Add Phase 6 note** to Developer Experience section -- append after DEVX-04:
    ```markdown
    - [x] **DEVX-05**: Interactive API playground in dashboard for testing endpoints
    ```

    **4. Update traceability table:**
    - Change ALL existing Status values from "Pending" to "Complete"
    - Add BKTS rows:
      ```
      | BKTS-01 | Phase 4 | Complete |
      | BKTS-02 | Phase 4 | Complete |
      | BKTS-03 | Phase 4 | Complete |
      | BKTS-04 | Phase 4 | Complete |
      ```
    - Add DEVX-05 row:
      ```
      | DEVX-05 | Phase 6 | Complete |
      ```

    **5. Update coverage stats:**
    ```markdown
    **Coverage:**
    - v1 requirements: 34 total (30 original + 4 BKTS)
    - Mapped to phases: 34
    - Unmapped: 0
    ```

    **6. Update the date footer:**
    ```markdown
    *Last updated: 2026-02-16 after v1 cleanup phase*
    ```

    **Do NOT:** Remove any v2 requirements. Do not modify the Out of Scope table.
  </action>
  <verify>
    Count checkboxes: `grep -c "\- \[x\]" .planning/REQUIREMENTS.md` should return 34. Count pending: `grep -c "\- \[ \]" .planning/REQUIREMENTS.md` should return 0. Verify BKTS section present: `grep "BKTS-01" .planning/REQUIREMENTS.md` returns a match. Verify date updated: `grep "2026-02-16" .planning/REQUIREMENTS.md` returns a match.
  </verify>
  <done>
    REQUIREMENTS.md contains all 34 v1 requirements marked complete. BKTS-01 through BKTS-04 are in their own Backtesting section. DEVX-05 added for Phase 6 playground. Traceability table has all entries with Complete status. Coverage count is 34. Date updated to 2026-02-16.
  </done>
</task>

</tasks>

<verification>
1. `cd dashboard && npx next build` -- zero TypeScript errors, zero import errors
2. `python -c "from src.api.models import OrderbookRequest, ErrorDetail; print('OK')"` -- backend models still parse
3. `ls dashboard/src/components/billing/payg-toggle.tsx` -- file does not exist
4. `grep -c "SeriesRecord" src/api/models.py` -- returns 0
5. `grep -c "\- \[x\]" .planning/REQUIREMENTS.md` -- returns 34
6. `grep -c "Pending" .planning/REQUIREMENTS.md` -- returns 0 (in traceability table context)
7. Manual: Open playground in browser, verify timestamp is visible and required, submit without it to confirm error appears
</verification>

<success_criteria>
- Playground timestamp validation prevents raw 422 errors (shows client-side error instead)
- Timestamp field is promoted to visible required field matching Market Ticker pattern
- requestError state is rendered in the playground page (was previously unused)
- PaygToggle component file deleted, SeriesRecord/SeriesResponse removed from models.py
- REQUIREMENTS.md has 34 requirements, all marked Complete, with BKTS and DEVX-05 sections added
- Dashboard builds with zero errors after all changes
</success_criteria>

<output>
After completion, create `.planning/phases/07-v1-cleanup-polish/07-01-SUMMARY.md`
</output>
