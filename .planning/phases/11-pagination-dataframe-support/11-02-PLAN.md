---
phase: 11-pagination-dataframe-support
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - sdk/src/kalshibook/client.py
  - sdk/tests/test_pagination.py
autonomous: true

must_haves:
  truths:
    - "User can iterate all deltas across pages via `for delta in client.list_deltas(ticker, start, end)`"
    - "User can iterate all trades across pages via `for trade in client.list_trades(ticker, start, end)`"
    - "User can query settlements via `client.list_settlements()` and receive a SettlementsResponse"
    - "User can get a single settlement via `client.get_settlement(ticker)`"
    - "Async variants (alist_deltas, alist_trades, alist_settlements, aget_settlement) work correctly"
    - "list_deltas(...).to_df() returns a pandas DataFrame with all records from all pages"
    - "First page is fetched eagerly so errors surface at method call time, not during iteration"
    - "to_df() raises ImportError with install hint when pandas is not available"
  artifacts:
    - path: "sdk/src/kalshibook/client.py"
      provides: "Paginated and settlement endpoint methods"
      contains: "def list_deltas"
    - path: "sdk/tests/test_pagination.py"
      provides: "Tests for pagination, settlements, and DataFrame conversion"
      contains: "def test_list_deltas"
  key_links:
    - from: "sdk/src/kalshibook/client.py"
      to: "sdk/src/kalshibook/_pagination.py"
      via: "import PageIterator"
      pattern: "from kalshibook._pagination import PageIterator"
    - from: "sdk/src/kalshibook/client.py"
      to: "sdk/src/kalshibook/models.py"
      via: "import DeltasResponse, TradesResponse, SettlementsResponse, SettlementResponse"
      pattern: "from kalshibook.models import"
    - from: "sdk/tests/test_pagination.py"
      to: "sdk/src/kalshibook/client.py"
      via: "import KalshiBook and call endpoint methods"
      pattern: "from kalshibook import KalshiBook"
---

<objective>
Add paginated endpoint methods (list_deltas, list_trades) and settlement endpoint methods (list_settlements, get_settlement) to the KalshiBook client, plus comprehensive tests covering multi-page iteration, DataFrame conversion, and edge cases.

Purpose: Completes the SDK's data access layer -- users can now iterate any result set (deltas, trades, settlements) and convert to DataFrames for analysis.

Output: Updated `client.py` with 8 new methods (4 sync + 4 async), new `test_pagination.py` with ~12-15 tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-pagination-dataframe-support/11-RESEARCH.md
@.planning/phases/11-pagination-dataframe-support/11-01-SUMMARY.md
@sdk/src/kalshibook/client.py
@sdk/src/kalshibook/_pagination.py
@sdk/src/kalshibook/models.py
@sdk/tests/test_endpoints.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add settlement and paginated endpoint methods to KalshiBook client</name>
  <files>sdk/src/kalshibook/client.py</files>
  <action>
Add 8 new methods to the KalshiBook class. Follow the existing endpoint method patterns established in Phase 10.

**New imports needed at top of client.py:**
- `from kalshibook._pagination import PageIterator`
- Add `DeltasResponse`, `TradesResponse`, `SettlementsResponse`, `SettlementResponse` to the existing `from kalshibook.models import (...)` block
- Also import `DeltaRecord`, `TradeRecord` for PageIterator type annotations

**Settlement endpoints (non-paginated, follow Phase 10 pattern):**

1. `list_settlements(self, *, event_ticker: str | None = None, result: str | None = None) -> SettlementsResponse`:
   - Build optional params dict (same pattern as list_events)
   - GET `/settlements` with params
   - Parse and return SettlementsResponse

2. `alist_settlements(...)` -- async variant

3. `get_settlement(self, ticker: str) -> SettlementResponse`:
   - GET `/settlements/{ticker}`
   - Parse and return SettlementResponse

4. `aget_settlement(...)` -- async variant

**Paginated endpoints (use PageIterator):**

5. `list_deltas(self, ticker: str, start_time: datetime, end_time: datetime, *, limit: int = 100) -> PageIterator[DeltaRecord]`:
   - Pre-compute `st = self._ensure_tz(start_time).isoformat()` and `et = self._ensure_tz(end_time).isoformat()` OUTSIDE the closure
   - Define inner `fetch_page(cursor: str | None) -> tuple[list[DeltaRecord], bool, str | None]`:
     - Build body dict: `{"market_ticker": ticker, "start_time": st, "end_time": et, "limit": limit}`
     - If cursor is not None, add `"cursor": cursor` to body
     - `resp = self._request("POST", "/deltas", json=body)`
     - `parsed = self._parse_response(resp, DeltasResponse)`
     - Return `(parsed.data, parsed.has_more, parsed.next_cursor)`
   - Fetch first page eagerly: `items, has_more, next_cursor = fetch_page(None)`
   - Return `PageIterator(items, has_more, next_cursor, fetch_page=fetch_page)`

6. `alist_deltas(...)` -- async variant:
   - Same structure but define `async def afetch_page(cursor)` using `await self._arequest(...)`
   - Fetch first page eagerly with `await afetch_page(None)`
   - Return `PageIterator(items, has_more, next_cursor, afetch_page=afetch_page)`

7. `list_trades(self, ticker: str, start_time: datetime, end_time: datetime, *, limit: int = 100) -> PageIterator[TradeRecord]`:
   - Same pattern as list_deltas but uses `TradesResponse`, `TradeRecord`
   - POST `/trades` with body `{"market_ticker": ticker, "start_time": st, "end_time": et, "limit": limit, "cursor"?: cursor}`

8. `alist_trades(...)` -- async variant

Add sections with comment headers matching existing style: `# -- Settlements --` and `# -- Deltas (paginated) --` and `# -- Trades (paginated) --`.

Include numpy-style docstrings on all public methods with Parameters/Returns/Raises sections. Show usage examples in docstrings for list_deltas and list_trades showing both `for` loop and `.to_df()` usage.
  </action>
  <verify>
Run `python -c "from kalshibook import KalshiBook; print([m for m in dir(KalshiBook) if not m.startswith('_') and 'delta' in m or 'trade' in m or 'settlement' in m])"` to confirm methods exist.
  </verify>
  <done>KalshiBook has 8 new endpoint methods: list_deltas, alist_deltas, list_trades, alist_trades, list_settlements, alist_settlements, get_settlement, aget_settlement. Paginated methods return PageIterator. Settlement methods return typed responses.</done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive pagination, settlements, and DataFrame tests</name>
  <files>sdk/tests/test_pagination.py</files>
  <action>
Create a new test file `sdk/tests/test_pagination.py` with the following tests. Use the same patterns as `test_endpoints.py` (constants, httpx_mock fixtures, sync client with `KalshiBook("kb-test-key")`).

**Constants:** Reuse `BASE_URL`, `CREDIT_HEADERS` pattern. Define `TS = "2026-01-15T12:00:00+00:00"`, `START = datetime(2026, 1, 15, 0, 0, tzinfo=timezone.utc)`, `END = datetime(2026, 1, 16, 0, 0, tzinfo=timezone.utc)`.

**Pagination tests:**

1. `test_list_deltas_single_page` -- single page with has_more=False, iterate all items, verify count and field values
2. `test_list_deltas_multi_page` -- two httpx mock responses: page 1 (has_more=True, next_cursor="cursor_abc"), page 2 (has_more=False). Use `list(client.list_deltas(...))` and verify all items from both pages, assert len == 2
3. `test_list_deltas_empty` -- empty data, has_more=False. Verify `list(iterator)` == []
4. `test_list_trades_single_page` -- single page of trades, verify TradeRecord fields
5. `test_list_trades_multi_page` -- same multi-page pattern as deltas but for trades

**Settlement tests:**

6. `test_list_settlements` -- GET /settlements returns SettlementsResponse with list of records
7. `test_list_settlements_filters` -- verify event_ticker and result params are sent as query params
8. `test_get_settlement` -- GET /settlements/{ticker} returns single SettlementResponse
9. `test_get_settlement_not_found` -- 404 raises MarketNotFoundError (same error type used for settlement 404s)

**DataFrame tests:**

10. `test_page_iterator_to_df` -- list_deltas(...).to_df() returns DataFrame with correct columns and row count. Requires pandas in test env. Use `pytest.importorskip("pandas")` to skip if pandas not installed.
11. `test_to_df_after_partial_iteration` -- iterate 1 item from a 2-item single page, then call .to_df(). Verify DataFrame contains ALL 2 records (not just the remaining 1).
12. `test_to_df_raises_without_pandas` -- monkeypatch `builtins.__import__` to block pandas import. Verify `iterator.to_df()` raises ImportError matching `"kalshibook\\[pandas\\]"`. (Follow exact pattern from research doc)
13. `test_settlements_response_to_df` -- `client.list_settlements().to_df()` returns DataFrame with settlement columns

**Async tests (representative):**

14. `test_alist_deltas` -- async list_deltas with single page, async for iteration
15. `test_aget_settlement` -- async get_settlement returning single record

All tests should call `client.close()` (or `await client.aclose()`) at the end. Use `@pytest.mark.asyncio` for async tests. Use `pytest.importorskip("pandas")` for DataFrame tests, not a global skip.
  </action>
  <verify>
Run `cd sdk && uv run pytest tests/test_pagination.py -v` -- all tests pass. Also run `cd sdk && uv run pytest tests/ -v` to confirm no regression on existing tests.
  </verify>
  <done>test_pagination.py exists with ~15 tests covering multi-page iteration, settlements, DataFrame conversion, error cases, and async variants. All tests pass.</done>
</task>

</tasks>

<verification>
1. `cd sdk && uv run pytest tests/ -v` -- ALL tests pass (existing + new)
2. Verify multi-page pagination: test_list_deltas_multi_page and test_list_trades_multi_page both pass
3. Verify DataFrame completeness: test_to_df_after_partial_iteration proves .to_df() includes already-iterated items
4. Verify optional pandas: test_to_df_raises_without_pandas proves ImportError with install hint
5. Verify settlements: test_list_settlements and test_get_settlement both pass
6. `python -c "from kalshibook import KalshiBook, PageIterator; print('SDK ready')"` succeeds
</verification>

<success_criteria>
- `for delta in client.list_deltas(ticker, start, end)` iterates across multiple pages transparently
- `for trade in client.list_trades(ticker, start, end)` iterates across multiple pages transparently
- `client.list_settlements()` returns SettlementsResponse with .data and .to_df()
- `client.get_settlement(ticker)` returns SettlementResponse with single record
- `client.list_deltas(...).to_df()` returns pandas DataFrame with all records from all pages
- Async variants all work (alist_deltas, alist_trades, alist_settlements, aget_settlement)
- pandas is optional -- tests confirm ImportError when pandas is missing
- All 15+ tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-pagination-dataframe-support/11-02-SUMMARY.md`
</output>
