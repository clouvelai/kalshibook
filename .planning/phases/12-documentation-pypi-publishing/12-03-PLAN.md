---
phase: 12-documentation-pypi-publishing
plan: 03
type: execute
wave: 3
depends_on: ["12-01", "12-02"]
files_modified:
  - .github/workflows/docs.yml
  - .github/workflows/publish.yml

must_haves:
  truths:
    - "uv build --package kalshibook produces a valid wheel with py.typed included"
    - "The wheel installs in a clean environment and imports correctly"
    - "mypy --strict passes on consumer code importing the installed package"
    - "GitHub Actions workflows are configured for docs deployment and PyPI publishing"
  artifacts:
    - path: ".github/workflows/docs.yml"
      provides: "Docs deployment workflow"
      contains: "mkdocs gh-deploy"
    - path: ".github/workflows/publish.yml"
      provides: "PyPI publish workflow"
      contains: "gh-action-pypi-publish"
  key_links:
    - from: ".github/workflows/publish.yml"
      to: "sdk/pyproject.toml"
      via: "uv build --package kalshibook"
      pattern: "uv build --package kalshibook"
    - from: ".github/workflows/docs.yml"
      to: "sdk/mkdocs.yml"
      via: "mkdocs gh-deploy"
      pattern: "mkdocs gh-deploy"

autonomous: false

user_setup:
  - service: pypi
    why: "PyPI Trusted Publisher for OIDC-based publishing without API tokens"
    dashboard_config:
      - task: "Register GitHub repository as a trusted publisher on PyPI"
        location: "pypi.org -> Your projects -> kalshibook -> Publishing -> Add a new publisher"
      - task: "Configure: Owner=your-github-org, Repository=kalshibook, Workflow=publish.yml, Environment=pypi"
        location: "pypi.org -> Trusted Publishers form"
  - service: github
    why: "Enable GitHub Pages for docs hosting"
    dashboard_config:
      - task: "Enable GitHub Pages with source: Deploy from a branch (gh-pages)"
        location: "GitHub repo -> Settings -> Pages"
---

<objective>
Verify package build, create CI/CD workflows, and prepare for PyPI publishing.

Purpose: Validates that the package is publishable (wheel correct, py.typed works, types check) and sets up automation for ongoing docs deployment and package releases. Satisfies PACK-01 and the remaining success criteria (mypy --strict on consumer code).
Output: Two GitHub Actions workflows, verified wheel build, confirmed py.typed functionality.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-documentation-pypi-publishing/12-RESEARCH.md
@.planning/phases/12-documentation-pypi-publishing/12-01-SUMMARY.md
@.planning/phases/12-documentation-pypi-publishing/12-02-SUMMARY.md
@sdk/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify package build, py.typed, and type checking</name>
  <files></files>
  <action>
    This task verifies build artifacts without modifying source files.

    1. Build the package: `uv build --package kalshibook`

    2. Verify py.typed is included in the wheel:
       ```bash
       python -c "
       import zipfile, glob
       whl = glob.glob('sdk/dist/*.whl')[0]
       with zipfile.ZipFile(whl) as z:
           names = z.namelist()
           assert any('py.typed' in n for n in names), 'py.typed missing from wheel!'
           print('py.typed found in wheel')
           for n in sorted(names):
               print(f'  {n}')
       "
       ```

    3. Install the built wheel in a temporary venv and verify imports:
       ```bash
       uv venv /tmp/kalshibook-test-venv
       uv pip install --python /tmp/kalshibook-test-venv/bin/python sdk/dist/kalshibook-*.whl
       /tmp/kalshibook-test-venv/bin/python -c "from kalshibook import KalshiBook, __version__; print(f'kalshibook {__version__} installed successfully')"
       ```

    4. Verify mypy --strict works on consumer code:
       Create a temp file `/tmp/test_kalshibook_typing.py`:
       ```python
       from kalshibook import KalshiBook, KalshiBookError, PageIterator, __version__

       client: KalshiBook = KalshiBook(api_key="kb-test")
       ver: str = __version__
       ```
       Run: `uv pip install --python /tmp/kalshibook-test-venv/bin/python mypy && /tmp/kalshibook-test-venv/bin/python -m mypy --strict /tmp/test_kalshibook_typing.py`

    5. Clean up: `rm -rf /tmp/kalshibook-test-venv /tmp/test_kalshibook_typing.py`
  </action>
  <verify>
    - `uv build --package kalshibook` produces sdist and wheel in sdk/dist/
    - py.typed is present in the wheel
    - Package installs and imports correctly in a clean venv
    - mypy --strict passes on consumer code
  </verify>
  <done>Package build verified: wheel contains py.typed, installs cleanly, and passes mypy --strict type checking in consumer code.</done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions workflows for docs and publishing</name>
  <files>
    .github/workflows/docs.yml
    .github/workflows/publish.yml
  </files>
  <action>
    1. Create `.github/workflows/docs.yml` for documentation deployment:
       - Trigger: push to main when sdk/docs/**, sdk/mkdocs.yml, sdk/src/**, or sdk/scripts/** change
       - Permissions: contents: write
       - Steps: checkout, setup-python 3.12, pip install docs dependencies (mkdocs-material, mkdocstrings[python], mkdocs-gen-files, mkdocs-literate-nav, mkdocs-section-index), configure git credentials for github-actions[bot], run `cd sdk && mkdocs gh-deploy --force`

    2. Create `.github/workflows/publish.yml` for PyPI publishing:
       - Trigger: release published
       - Two jobs: build and publish
       - Build job: checkout, setup-uv (astral-sh/setup-uv@v5), `uv build --package kalshibook`, upload-artifact (dist files)
       - Publish job: needs build, runs on ubuntu-latest, environment: pypi, permissions: id-token: write, download-artifact, use pypa/gh-action-pypi-publish@release/v1
       - Follow the research Pattern 5 exactly.

    3. Verify YAML syntax: `python -c "import yaml; yaml.safe_load(open('.github/workflows/docs.yml')); yaml.safe_load(open('.github/workflows/publish.yml')); print('YAML valid')"` (or use `uv run python` if PyYAML is available).
  </action>
  <verify>
    - `.github/workflows/docs.yml` exists with correct trigger paths and mkdocs gh-deploy step
    - `.github/workflows/publish.yml` exists with release trigger, build + publish jobs, id-token: write permission
    - YAML files parse without errors
  </verify>
  <done>Both CI/CD workflows created: docs deploys on push to main, package publishes on GitHub release via trusted publisher.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: User publishes package to PyPI</name>
  <files></files>
  <action>
    The package is built and verified locally. GitHub Actions workflows are in place. To complete PACK-01, the user must publish to PyPI. Claude cannot do this (requires PyPI account credentials).

    **Option A: Manual first publish (recommended for first release)**
    1. Create a PyPI account at pypi.org if you don't have one
    2. Generate an API token at pypi.org -> Account settings -> API tokens
    3. Run: `uv publish sdk/dist/* --token pypi-YOUR-TOKEN`

    **Option B: Publish via GitHub Actions (for subsequent releases)**
    1. Register trusted publisher at pypi.org (Owner, Repo, Workflow=publish.yml, Environment=pypi)
    2. Enable GitHub Pages in repo settings (source: gh-pages branch)
    3. Create a GitHub release tagged `v0.1.0`
    4. The publish workflow will automatically build and publish to PyPI

    Type "published" once the package is on PyPI, or "skip" to complete the phase without publishing (can publish later via GitHub release).
  </action>
  <verify>
    ```bash
    pip install kalshibook
    python -c "from kalshibook import KalshiBook, __version__; print(__version__)"
    ```
  </verify>
  <done>Package is published on PyPI and installable via `pip install kalshibook`.</done>
</task>

</tasks>

<verification>
1. `uv build --package kalshibook` succeeds
2. Wheel contains py.typed marker
3. Package installs and imports in clean venv
4. mypy --strict passes on consumer code
5. `.github/workflows/docs.yml` and `.github/workflows/publish.yml` exist with valid YAML
6. `pip install kalshibook` works from PyPI (after user publishes)
</verification>

<success_criteria>
- Package build produces valid wheel with py.typed
- Consumer code passes mypy --strict (py.typed works end-to-end)
- CI/CD workflows ready for docs deployment and PyPI publishing
- PACK-01 satisfied: package is publishable (and published if user completes checkpoint)
</success_criteria>

<output>
After completion, create `.planning/phases/12-documentation-pypi-publishing/12-03-SUMMARY.md`
</output>
