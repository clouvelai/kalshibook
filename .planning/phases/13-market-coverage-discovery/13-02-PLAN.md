---
phase: 13-market-coverage-discovery
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - dashboard/src/app/(dashboard)/coverage/page.tsx
  - dashboard/src/components/coverage/coverage-table.tsx
  - dashboard/src/components/coverage/coverage-search.tsx
  - dashboard/src/components/coverage/coverage-summary-cards.tsx
  - dashboard/src/components/coverage/coverage-timeline-bar.tsx
  - dashboard/src/components/coverage/coverage-segment-detail.tsx
  - dashboard/src/components/sidebar/app-sidebar.tsx
  - dashboard/src/types/api.ts
  - dashboard/src/lib/api.ts
autonomous: false

must_haves:
  truths:
    - "User can view a paginated table of all markets with data, showing contiguous coverage segments for each"
    - "User can see per-market summary stats (total data points, segment count, snapshot/delta/trade counts) that load in under 2 seconds"
    - "User can search markets by ticker substring and filter by event or active/settled status, with results updating as they type"
    - "Markets are grouped under parent events using nested accordion expanded by default"
    - "Summary cards above the table show total markets, total snapshots, total deltas, and date range"
    - "Mini timeline bar shows colored segment blocks with gaps for each market"
    - "Expanding a market row shows per-segment date ranges and counts"
  artifacts:
    - path: "dashboard/src/app/(dashboard)/coverage/page.tsx"
      provides: "Coverage page with data fetching, loading states, error handling"
      min_lines: 50
    - path: "dashboard/src/components/coverage/coverage-table.tsx"
      provides: "TanStack Table with expanding rows for event accordion pattern"
      contains: "getExpandedRowModel"
    - path: "dashboard/src/components/coverage/coverage-search.tsx"
      provides: "Debounced search input with filter dropdowns"
      contains: "setTimeout"
    - path: "dashboard/src/components/coverage/coverage-summary-cards.tsx"
      provides: "Four summary stat cards with compact number formatting"
      contains: "Intl.NumberFormat"
    - path: "dashboard/src/components/coverage/coverage-timeline-bar.tsx"
      provides: "Mini timeline bar with positioned segment blocks"
      min_lines: 20
    - path: "dashboard/src/components/coverage/coverage-segment-detail.tsx"
      provides: "Expanded row showing per-segment date ranges and stats"
      min_lines: 15
    - path: "dashboard/src/components/sidebar/app-sidebar.tsx"
      provides: "Coverage nav item in sidebar"
      contains: "Coverage"
    - path: "dashboard/src/types/api.ts"
      provides: "TypeScript interfaces for coverage response types"
      contains: "CoverageStatsResponse"
    - path: "dashboard/src/lib/api.ts"
      provides: "Coverage API method in api client"
      contains: "coverage"
  key_links:
    - from: "dashboard/src/app/(dashboard)/coverage/page.tsx"
      to: "dashboard/src/lib/api.ts"
      via: "api.coverage.stats() call"
      pattern: "api\\.coverage\\.stats"
    - from: "dashboard/src/lib/api.ts"
      to: "/coverage/stats"
      via: "fetchAPI call"
      pattern: "/coverage/stats"
    - from: "dashboard/src/components/coverage/coverage-table.tsx"
      to: "@tanstack/react-table"
      via: "useReactTable with getExpandedRowModel"
      pattern: "getExpandedRowModel"
    - from: "dashboard/src/components/sidebar/app-sidebar.tsx"
      to: "dashboard/src/app/(dashboard)/coverage/page.tsx"
      via: "sidebar nav link to /coverage"
      pattern: '"/coverage"'
---

<objective>
Build the Coverage dashboard page: a browsable, searchable table of markets grouped by event with pre-computed segment stats, mini timeline bars, summary cards, and debounced search/filter.

Purpose: Users can discover which markets have data, how much coverage exists, and where the gaps are -- the primary deliverable of Phase 13 (COVR-01, COVR-02, COVR-03).
Output: New /coverage dashboard page with all components, sidebar navigation, TypeScript types, API client method.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-market-coverage-discovery/13-RESEARCH.md
@.planning/phases/13-market-coverage-discovery/13-01-SUMMARY.md
@dashboard/src/app/(dashboard)/page.tsx
@dashboard/src/components/sidebar/app-sidebar.tsx
@dashboard/src/lib/api.ts
@dashboard/src/types/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TypeScript types, API client method, and sidebar navigation</name>
  <files>
    dashboard/src/types/api.ts
    dashboard/src/lib/api.ts
    dashboard/src/components/sidebar/app-sidebar.tsx
  </files>
  <action>
**In dashboard/src/types/api.ts**, add coverage types at the end of the file:

```typescript
/** Coverage types */

export interface CoverageSegment {
  segment_id: number;
  segment_start: string;
  segment_end: string;
  days_covered: number;
  snapshot_count: number;
  delta_count: number;
  trade_count: number;
}

export interface MarketCoverage {
  ticker: string;
  title: string | null;
  status: string | null;
  segment_count: number;
  total_snapshots: number;
  total_deltas: number;
  total_trades: number;
  first_date: string | null;
  last_date: string | null;
  segments: CoverageSegment[];
}

export interface EventCoverageGroup {
  event_ticker: string;
  event_title: string | null;
  market_count: number;
  markets: MarketCoverage[];
}

export interface CoverageSummary {
  total_markets: number;
  total_snapshots: number;
  total_deltas: number;
  date_range_start: string | null;
  date_range_end: string | null;
}

export interface CoverageStatsResponse {
  summary: CoverageSummary;
  events: EventCoverageGroup[];
  total_events: number;
  request_id: string;
  response_time: number;
}
```

**In dashboard/src/lib/api.ts**, add a `coverage` namespace to the `api` object:

```typescript
coverage: {
  stats: (params?: {
    search?: string;
    status?: string;
    event_ticker?: string;
    page?: number;
    page_size?: number;
  }) => {
    const searchParams = new URLSearchParams();
    if (params?.search) searchParams.set("search", params.search);
    if (params?.status) searchParams.set("status", params.status);
    if (params?.event_ticker) searchParams.set("event_ticker", params.event_ticker);
    if (params?.page) searchParams.set("page", String(params.page));
    if (params?.page_size) searchParams.set("page_size", String(params.page_size));
    const qs = searchParams.toString();
    return fetchAPI<CoverageStatsResponse>(`/coverage/stats${qs ? `?${qs}` : ""}`);
  },
  refresh: () =>
    fetchAPI<{ message: string; request_id: string }>("/coverage/refresh", {
      method: "POST",
    }),
},
```

Import the `CoverageStatsResponse` type in the import block at the top of api.ts.

**In dashboard/src/components/sidebar/app-sidebar.tsx**, add a Coverage nav item between "Overview" and "Playground":

```typescript
import { Database } from "lucide-react";  // add to existing import
```

Add this item to `navItems` array after Overview, before Playground:
```typescript
{
  title: "Coverage",
  href: "/coverage",
  icon: Database,
  external: false,
},
```
  </action>
  <verify>
TypeScript compiles without errors: `cd dashboard && npx tsc --noEmit`. Sidebar renders with "Coverage" link.
  </verify>
  <done>
Coverage TypeScript types match backend models, API client has coverage.stats() and coverage.refresh() methods, sidebar has Coverage nav item with Database icon.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build coverage page and all UI components</name>
  <files>
    dashboard/src/app/(dashboard)/coverage/page.tsx
    dashboard/src/components/coverage/coverage-table.tsx
    dashboard/src/components/coverage/coverage-search.tsx
    dashboard/src/components/coverage/coverage-summary-cards.tsx
    dashboard/src/components/coverage/coverage-timeline-bar.tsx
    dashboard/src/components/coverage/coverage-segment-detail.tsx
  </files>
  <action>
Create all 6 files. Follow the existing dashboard patterns from page.tsx (Overview) for data fetching, loading/error states, and layout.

**coverage-summary-cards.tsx** -- Four summary cards in a responsive grid:
- "Markets Tracked" -- total_markets count
- "Total Snapshots" -- total_snapshots with compact notation using `Intl.NumberFormat("en-US", { notation: "compact", maximumFractionDigits: 1 })`
- "Total Deltas" -- total_deltas with compact notation
- "Date Range" -- date_range_start to date_range_end formatted as "Feb 13 - Feb 18, 2026" style
- Use the existing `Card`, `CardContent` shadcn components
- Layout: `grid grid-cols-2 gap-4 lg:grid-cols-4`

**coverage-search.tsx** -- Debounced search and filter controls:
- DebouncedInput component using useState + useEffect setTimeout pattern with 300ms delay
- Search input with lucide `Search` icon, placeholder "Search markets..."
- Status filter: a `<select>` or shadcn Select with options: All, Active, Settled
- Clear filters link that resets all filters when visible (show only when any filter is active)
- Layout: horizontal flex row with gap between search and filters
- Props: `{ search, onSearchChange, status, onStatusChange }` -- controlled from parent page

**coverage-timeline-bar.tsx** -- Mini timeline bar:
- Props: `{ segments: CoverageSegment[], overallStart: string, overallEnd: string }`
- Container: `relative h-2 w-full rounded-full bg-muted overflow-hidden`
- Each segment positioned absolutely with `left` and `width` as percentages of total date range
- Segment color: `bg-primary`
- Min width of 2px for very short segments so they're visible
- Helper function `daysBetween(dateA: string, dateB: string): number` using Date math
- If no segments, return null (parent handles empty state)

**coverage-segment-detail.tsx** -- Expanded row showing segments:
- Props: `{ segments: CoverageSegment[] }`
- Renders a compact list of segments, each showing:
  - Date range: "Feb 13 - Feb 15, 2026" (formatted nicely)
  - Stats: "1.2K snapshots | 45K deltas | 892 trades" using compact notation
  - Days covered badge
- Layout: vertical stack with small gap, light background (`bg-muted/50`), rounded, padded

**coverage-table.tsx** -- TanStack Table with expanding rows:
- Data model: Transform `EventCoverageGroup[]` into a flat row array where:
  - Event rows have `isEventHeader: true`, span all columns, contain event_ticker + event_title + market count
  - Market rows have market coverage data
- Use `useReactTable` with `getCoreRowModel()` and `getExpandedRowModel()`
- Alternatively, since TanStack's `getSubRows` approach needs nested data: shape data as rows with `subRows`. Each event becomes a parent row, markets are sub-rows.
- Initial expanded state: `true` (all expanded by default per user decision)
- Columns for market rows:
  1. Expand toggle + Ticker (with title below in muted text)
  2. Coverage range ("Feb 13 - Feb 18")
  3. Snapshots / Deltas / Trades (3 compact numbers separated by " | ")
  4. Segments column: segment count text + TimelineBar component inline
- Event header rows: render a single cell spanning the row with expand toggle, event title (or event_ticker if no title), and market count badge
- On row expand (clicking a market row): show CoverageSegmentDetail below the row
- Use `flexRender` for cells
- No-results state: "No markets match your search" with a "Clear filters" button (per user decision)
- Style with Tailwind -- compact rows, clean borders, alternating background subtle

**coverage/page.tsx** -- Main page component:
- "use client" directive
- State: `search`, `status`, `page`, `data` (CoverageStatsResponse | null), `loading`, `error`
- Fetch data using `api.coverage.stats({ search, status, page, page_size: 20 })` inside useEffect triggered by search/status/page changes
- Add a separate loading state for initial load vs filter updates (show skeleton for initial, keep table visible during filter updates)
- Page header: "Coverage" title with "Discover which markets have data and where the gaps are" subtitle (matches Overview pattern: `text-2xl font-semibold tracking-tight` for title, `text-sm text-muted-foreground` for subtitle)
- Layout order: header, summary cards, search/filters, table, pagination
- Pagination: simple prev/next buttons with "Page X of Y" text, disabled at boundaries
- Loading state: Skeleton matching Overview pattern -- skeleton cards + skeleton table block
- Error state: Card with error message and retry button (matches Overview pattern)
  </action>
  <verify>
Run `cd dashboard && npm run build` to verify no build errors. Start the dashboard and navigate to /coverage -- page should render with summary cards, search bar, and the coverage table with event grouping.
  </verify>
  <done>
Coverage page renders at /coverage with summary cards, debounced search, status filter, event-grouped table with expanding rows showing per-segment details and timeline bars. Pagination works at event-group level.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify coverage page end-to-end</name>
  <files>dashboard/src/app/(dashboard)/coverage/page.tsx</files>
  <action>
CHECKPOINT: Human verifies the complete Market Coverage Discovery feature.

What was built:
- Backend: Materialized view with gaps-and-islands segment detection, GET /coverage/stats endpoint, POST /coverage/refresh endpoint
- Frontend: /coverage dashboard page with summary cards, debounced search, status filter, event-grouped accordion table with timeline bars and expandable segment details
  </action>
  <verify>
1. Navigate to http://localhost:3000/coverage in the dashboard
2. Verify summary cards show at the top (Markets Tracked, Total Snapshots, Total Deltas, Date Range) with abbreviated numbers
3. Verify the table shows markets grouped under event headers with expand/collapse toggles
4. Verify each market row shows: ticker, title, coverage range, data point counts, segment count + timeline bar
5. Click a market row to expand -- verify per-segment details (date ranges + counts) appear
6. Type a partial ticker in the search box -- verify results filter live (~300ms debounce)
7. Select "Active" or "Settled" from the status filter -- verify results update
8. Clear all filters -- verify the full list returns
9. Verify the "Coverage" link appears in the sidebar between Overview and Playground
10. Verify page loads in under 2 seconds (data comes from materialized view)
  </verify>
  <done>User confirms the coverage page works correctly with all features. Type "approved" or describe issues to fix.</done>
</task>

</tasks>

<verification>
1. /coverage route exists and renders in the dashboard
2. Summary cards show aggregate stats with compact notation
3. Table groups markets under events, all expanded by default
4. Market rows show ticker, title, coverage range, counts, segment count + timeline bar
5. Expanding a market row shows per-segment date ranges and counts
6. Debounced search filters by ticker substring within ~300ms
7. Status filter updates results
8. Pagination navigates event groups (20 per page)
9. Coverage nav item appears in sidebar with Database icon
10. Page loads in under 2 seconds from materialized view
</verification>

<success_criteria>
- User can browse all markets with data, grouped by event, in a clean table
- User can see per-market summary stats (segment count, snapshot/delta/trade counts)
- User can search by ticker and filter by status with live updating
- Summary cards show abbreviated totals above the table
- Timeline bars visually represent coverage segments and gaps
- Page loads quickly from pre-computed materialized view data
</success_criteria>

<output>
After completion, create `.planning/phases/13-market-coverage-discovery/13-02-SUMMARY.md`
</output>
