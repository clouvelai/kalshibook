---
phase: 14-playground-upgrade
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/routes/playground.py
  - src/api/models.py
  - src/api/main.py
  - dashboard/src/components/ui/command.tsx
  - dashboard/src/components/ui/popover.tsx
autonomous: true

must_haves:
  truths:
    - "GET /playground/markets?q=btc returns markets with confirmed data coverage matching the query"
    - "POST /playground/demo with endpoint='orderbook' returns reconstructed orderbook data without deducting credits"
    - "POST /playground/demo with endpoint='trades' returns trade history without deducting credits"
    - "POST /playground/demo with endpoint='candles' returns candle data without deducting credits"
    - "All playground endpoints use JWT auth (get_authenticated_user), not API key auth"
    - "shadcn Command and Popover UI components are installed and importable"
  artifacts:
    - path: "src/api/routes/playground.py"
      provides: "Market search and demo execution endpoints"
      exports: ["router"]
    - path: "src/api/models.py"
      provides: "PlaygroundMarketResult, DemoRequest, DemoResponse models"
      contains: "class DemoRequest"
    - path: "dashboard/src/components/ui/command.tsx"
      provides: "shadcn Command component (cmdk wrapper)"
    - path: "dashboard/src/components/ui/popover.tsx"
      provides: "shadcn Popover component"
  key_links:
    - from: "src/api/routes/playground.py"
      to: "src/api/services/reconstruction.py"
      via: "reconstruct_orderbook import"
      pattern: "from src\\.api\\.services\\.reconstruction import reconstruct_orderbook"
    - from: "src/api/routes/playground.py"
      to: "src/api/services/candles.py"
      via: "get_candles import"
      pattern: "from src\\.api\\.services\\.candles import.*get_candles"
    - from: "src/api/main.py"
      to: "src/api/routes/playground.py"
      via: "router registration"
      pattern: "app\\.include_router\\(playground\\.router\\)"
---

<objective>
Build the backend playground endpoints (market search for autocomplete + zero-credit demo execution) and install the shadcn UI component dependencies needed for the frontend.

Purpose: The backend endpoints provide the data layer for PLAY-01 (real market tickers), PLAY-02 (autocomplete search), and PLAY-04 (zero-credit demos). The shadcn components (Command + Popover) are needed by the frontend combobox in Plan 02.

Output: Two new FastAPI endpoints (`GET /playground/markets`, `POST /playground/demo`), Pydantic models, router registration, and shadcn Command + Popover components installed in the dashboard.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-playground-upgrade/14-RESEARCH.md
@src/api/routes/coverage.py
@src/api/deps.py
@src/api/models.py
@src/api/main.py
@src/api/services/reconstruction.py
@src/api/services/candles.py
@src/api/routes/trades.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backend playground endpoints and Pydantic models</name>
  <files>
    src/api/routes/playground.py
    src/api/models.py
    src/api/main.py
  </files>
  <action>
**1. Add Pydantic models to `src/api/models.py`:**

Add at the end of the file (before the Error models section):

```python
# ---------------------------------------------------------------------------
# Playground models
# ---------------------------------------------------------------------------

class PlaygroundMarketResult(BaseModel):
    """A market result for playground autocomplete."""
    ticker: str = Field(description="Market ticker")
    title: str | None = Field(default=None, description="Market title")
    status: str | None = Field(default=None, description="Market status")
    event_ticker: str | None = Field(default=None, description="Parent event ticker")
    first_date: str | None = Field(default=None, description="Earliest coverage date")
    last_date: str | None = Field(default=None, description="Latest coverage date")


class PlaygroundMarketsResponse(BaseModel):
    """Response for playground market search."""
    data: list[PlaygroundMarketResult]
    request_id: str


class DemoRequest(BaseModel):
    """Request to execute a zero-credit demo query."""
    endpoint: str = Field(description="Target endpoint: 'orderbook', 'trades', or 'candles'")
    market_ticker: str = Field(description="Kalshi market ticker")
    timestamp: datetime | None = Field(default=None, description="ISO 8601 timestamp (for orderbook)")
    depth: int | None = Field(default=None, ge=1, le=50, description="Orderbook depth limit")
    start_time: datetime | None = Field(default=None, description="Start time (for trades/candles)")
    end_time: datetime | None = Field(default=None, description="End time (for trades/candles)")
    interval: str | None = Field(default=None, description="Candle interval: 1m, 1h, 1d")
    limit: int = Field(default=20, ge=1, le=100, description="Result limit (for trades)")


class DemoResponse(BaseModel):
    """Response from a demo query execution."""
    endpoint: str = Field(description="Which endpoint was queried")
    data: dict | list = Field(description="Response data from the service")
    response_time: float = Field(description="Server-side processing time in seconds")
    request_id: str
    credits_cost: int = Field(default=0, description="Always 0 for demo requests")
```

**2. Create `src/api/routes/playground.py`:**

Create this file with two endpoints following the JWT auth pattern from `coverage.py`:

- `GET /playground/markets` -- Searches the `market_coverage_stats` materialized view joined with `markets` for autocomplete. Accepts `q` (search query, min 0 chars) and `limit` (default 10, max 50). Uses `get_authenticated_user` (JWT auth, NOT require_credits). Query: SELECT DISTINCT on market_ticker from `market_coverage_stats cs JOIN markets m ON m.ticker = cs.market_ticker` WHERE ticker ILIKE or title ILIKE the query, GROUP BY to get MIN(segment_start) as first_date and MAX(segment_end) as last_date. ORDER BY last_date DESC. Returns `PlaygroundMarketsResponse`.

- `POST /playground/demo` -- Accepts a `DemoRequest` body. Routes based on `body.endpoint`:
  - `"orderbook"`: Validates `timestamp` is present. Calls `reconstruct_orderbook(pool, body.market_ticker, body.timestamp, body.depth or 10)` from `src.api.services.reconstruction`. If result is None, raise `MarketNotFoundError`. If result has `error == "no_data"`, raise `NoDataAvailableError`. Otherwise, return the result dict wrapped in DemoResponse.
  - `"trades"`: Validates `start_time` and `end_time` are present. Runs the same SQL query as `trades.py` directly (since the route handler does the query, not a service function): SELECT from trades WHERE market_ticker=$1 AND ts >= $2 AND ts < $3 ORDER BY ts ASC LIMIT $4. Convert rows to list of dicts. Return in DemoResponse.
  - `"candles"`: Validates `start_time`, `end_time` present. Calls `get_candles(pool, body.market_ticker, body.start_time, body.end_time, VALID_INTERVALS.get(body.interval or "1h", "hour"))` from `src.api.services.candles`. Return rows in DemoResponse.
  - Any other endpoint value: raise `ValidationError("Invalid endpoint. Must be one of: orderbook, trades, candles")`.

  Uses `get_authenticated_user` for auth. Apply rate limiting of 20/minute on the demo endpoint using the existing limiter: `@limiter.limit("20/minute")` from `request.app.state.limiter`.

Import `from slowapi import Limiter` is NOT needed since we get the limiter from `request.app.state.limiter`. Use the `@app.state.limiter.limit()` pattern -- actually, the cleanest approach is to import the `limiter` from `src.api.main` -- but to avoid circular imports, just use `request.app.state.limiter` as a decorator won't work easily. Instead, skip the per-endpoint rate limit for now (the global 120/min rate limit already applies) -- it can be added later if abuse is detected. This keeps the code clean.

**3. Register the router in `src/api/main.py`:**

- Add `playground` to the imports: `from src.api.routes import auth, billing, candles, coverage, deltas, events, keys, markets, orderbook, playground, settlements, trades`
- Add the openapi tag for Playground (before Health tag):
  ```python
  {
      "name": "Playground",
      "description": "Zero-credit demo endpoints for the API playground.",
  },
  ```
- Add `app.include_router(playground.router)` after the coverage router registration.
  </action>
  <verify>
Run: `cd /Users/samuelclark/Desktop/kalshibook && python -c "from src.api.routes.playground import router; print('Router imported:', router.routes)"` to verify the module loads without import errors.

Run: `cd /Users/samuelclark/Desktop/kalshibook && python -c "from src.api.models import DemoRequest, DemoResponse, PlaygroundMarketResult; print('Models OK')"` to verify models parse.

Run: `cd /Users/samuelclark/Desktop/kalshibook && python -c "from src.api.main import app; routes = [r.path for r in app.routes]; assert '/playground/markets' in routes; assert '/playground/demo' in routes; print('Routes registered:', [r for r in routes if 'playground' in r])"` to verify router registration.
  </verify>
  <done>
- `GET /playground/markets` endpoint exists, uses JWT auth, queries coverage materialized view
- `POST /playground/demo` endpoint exists, uses JWT auth, routes to orderbook/trades/candles service functions
- All Pydantic models (PlaygroundMarketResult, DemoRequest, DemoResponse) are defined
- Router is registered in main.py with Playground tag in OpenAPI
- No credit deduction occurs on either endpoint
  </done>
</task>

<task type="auto">
  <name>Task 2: Install shadcn Command and Popover UI components</name>
  <files>
    dashboard/src/components/ui/command.tsx
    dashboard/src/components/ui/popover.tsx
  </files>
  <action>
Run `npx shadcn add command popover` from the `dashboard/` directory. This installs:
- `cmdk` npm package (the headless command component)
- Generates `dashboard/src/components/ui/command.tsx` (shadcn Command wrapper around cmdk)
- Generates `dashboard/src/components/ui/popover.tsx` (shadcn Popover wrapper around radix-ui)

The shadcn config is already set up (`dashboard/components.json` has "new-york" style, aliases configured). The `@radix-ui/react-popover` is already installed as part of the radix-ui bundle.

After installation, verify both files exist and that `cmdk` appears in `dashboard/package.json`.

If `npx shadcn add` prompts for overwrite, use `--overwrite` flag. If it requires interactive input, fall back to manually creating the components:
- For command.tsx: Use the standard shadcn command component code (wraps cmdk with cn() styling)
- For popover.tsx: Use the standard shadcn popover component code (wraps @radix-ui/react-popover)
  </action>
  <verify>
Run: `ls dashboard/src/components/ui/command.tsx dashboard/src/components/ui/popover.tsx` to verify files exist.

Run: `cd /Users/samuelclark/Desktop/kalshibook/dashboard && node -e "require('cmdk'); console.log('cmdk OK')"` to verify cmdk is installed.

Run: `grep -q 'cmdk' dashboard/package.json && echo 'cmdk in package.json'` to verify dependency is recorded.
  </verify>
  <done>
- `command.tsx` and `popover.tsx` exist in `dashboard/src/components/ui/`
- `cmdk` package is installed and listed in `dashboard/package.json`
- Both components are importable from `@/components/ui/command` and `@/components/ui/popover`
  </done>
</task>

</tasks>

<verification>
1. Python imports: `from src.api.routes.playground import router` succeeds
2. Python imports: `from src.api.models import DemoRequest, DemoResponse, PlaygroundMarketResult` succeeds
3. Routes registered: `/playground/markets` and `/playground/demo` appear in app.routes
4. shadcn components: `dashboard/src/components/ui/command.tsx` and `popover.tsx` exist
5. cmdk installed: appears in `dashboard/package.json` dependencies
</verification>

<success_criteria>
- Backend playground endpoints exist and use JWT auth (no credit deduction)
- Market search queries the coverage materialized view
- Demo execution routes to existing service functions (reconstruct_orderbook, get_candles, direct trades query)
- shadcn Command and Popover components are installed and ready for frontend use
</success_criteria>

<output>
After completion, create `.planning/phases/14-playground-upgrade/14-01-SUMMARY.md`
</output>
