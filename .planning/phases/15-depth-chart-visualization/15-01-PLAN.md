---
phase: 15-depth-chart-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dashboard/src/components/playground/depth-chart.tsx
  - dashboard/src/components/playground/response-panel.tsx
  - dashboard/src/components/playground/orderbook-preview.tsx
autonomous: true

must_haves:
  truths:
    - "User can view a depth chart showing Yes (green) and No (red) cumulative depth as stepped area fills across the 0-100 cent price range"
    - "Depth chart renders on an HTML Canvas element, not SVG"
    - "Depth chart appears as a 'Depth' tab alongside existing JSON and Preview tabs in the response panel"
    - "Depth tab only appears when response data is orderbook-shaped (has yes[] and no[] arrays)"
    - "Selecting a different market or timestamp updates the depth chart automatically (React re-render on prop change)"
    - "Depth chart renders crisply on Retina/HiDPI displays"
    - "Depth chart resizes responsively when container dimensions change"
  artifacts:
    - path: "dashboard/src/components/playground/depth-chart.tsx"
      provides: "Canvas-based depth chart component with cumulative data transformation, stepped area rendering, axes, grid, legend"
      min_lines: 120
    - path: "dashboard/src/components/playground/response-panel.tsx"
      provides: "Depth tab integration alongside JSON and Preview"
      contains: "TabsTrigger value=\"depth\""
    - path: "dashboard/src/components/playground/orderbook-preview.tsx"
      provides: "Exported isOrderbookData type guard and OrderbookData interface"
      contains: "export function isOrderbookData"
  key_links:
    - from: "dashboard/src/components/playground/response-panel.tsx"
      to: "dashboard/src/components/playground/depth-chart.tsx"
      via: "import { DepthChart }"
      pattern: "import.*DepthChart.*depth-chart"
    - from: "dashboard/src/components/playground/response-panel.tsx"
      to: "dashboard/src/components/playground/orderbook-preview.tsx"
      via: "import { isOrderbookData, OrderbookData }"
      pattern: "import.*isOrderbookData.*orderbook-preview"
    - from: "dashboard/src/components/playground/depth-chart.tsx"
      to: "dashboard/src/types/api.ts"
      via: "import { OrderbookLevel }"
      pattern: "import.*OrderbookLevel.*types/api"
---

<objective>
Create a Canvas-based depth chart component and wire it as a third tab ("Depth") in the playground response panel, showing cumulative orderbook depth for Yes and No sides across the 0-100 cent price range.

Purpose: Satisfies DPTH-01, DPTH-02, DPTH-03, and PLAY-05 -- the final requirements for v1.2. Users get a visual representation of orderbook depth at any covered timestamp, completing the playground experience.

Output: One new component (`depth-chart.tsx`), one modified file (`response-panel.tsx`), one minor export update (`orderbook-preview.tsx`).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-depth-chart-visualization/15-RESEARCH.md

@dashboard/src/components/playground/response-panel.tsx
@dashboard/src/components/playground/orderbook-preview.tsx
@dashboard/src/types/api.ts
@dashboard/src/components/ui/tabs.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Canvas depth chart component</name>
  <files>
    dashboard/src/components/playground/depth-chart.tsx
    dashboard/src/components/playground/orderbook-preview.tsx
  </files>
  <action>
    **Create `dashboard/src/components/playground/depth-chart.tsx`:**

    A "use client" React component that renders cumulative orderbook depth on an HTML Canvas. Follow the patterns from 15-RESEARCH.md exactly.

    **Props interface:**
    ```typescript
    interface DepthChartProps {
      yes: OrderbookLevel[];  // import from @/types/api
      no: OrderbookLevel[];
      className?: string;
    }
    ```

    **Data transformation (pure functions, not methods):**
    - `cumulativeYes(levels)`: Sort descending by price, accumulate quantities top-to-bottom. Returns `DepthPoint[]` where `DepthPoint = { price: number; cumulative: number }`.
    - `cumulativeNo(levels)`: Sort ascending by price, accumulate quantities bottom-to-top. Returns `DepthPoint[]`.
    - CRITICAL: Always spread before sorting (`[...levels].sort(...)`) to avoid mutating React state.
    - Guard against empty arrays (return `[]`).

    **Canvas rendering (`draw` function):**
    - Constants: `PADDING = { top: 20, right: 20, bottom: 40, left: 60 }`.
    - Colors: Yes = green (`rgba(34, 197, 94, 0.8)` stroke, `rgba(34, 197, 94, 0.15)` fill). No = red (`rgba(239, 68, 68, 0.8)` stroke, `rgba(239, 68, 68, 0.15)` fill).
    - X-axis: price 0-100 cents (fixed range, no dynamic scaling).
    - Y-axis: 0 to `Math.max(...allCumulativeValues, 1)` (the `1` prevents division by zero on empty data).
    - Scale functions: `scaleX(price) = PADDING.left + (price / 100) * chartW` and `scaleY(qty) = PADDING.top + chartH - (qty / maxQty) * chartH`.
    - Draw order: (1) clear canvas, (2) grid lines + axes, (3) Yes stepped area fill, (4) No stepped area fill, (5) legend.

    **`drawSteppedArea` function:**
    - Takes: ctx, points[], scaleX, scaleY, baseline (bottom of chart area), strokeColor, fillColor.
    - Begin path at `(scaleX(points[0].price), baseline)`.
    - For each point: lineTo `(x, y)`, then horizontal step to next point's x at current y.
    - Close path back to baseline. Fill with fillColor, stroke with strokeColor (lineWidth: 2).
    - Return early if `points.length === 0`.

    **`drawGrid` function:**
    - Draw light gridlines (use `rgba(128, 128, 128, 0.15)` or similar muted color).
    - X-axis labels: price ticks at 0, 25, 50, 75, 100 cents.
    - Y-axis labels: ~4 evenly spaced quantity ticks.
    - Axis label font: `12px` system font, fill color `rgba(128, 128, 128, 0.7)`.
    - X-axis title: "Price (cents)" centered below ticks.
    - Y-axis title: "Cumulative Quantity" rotated 90deg left of ticks (use `ctx.save/rotate/restore`).

    **`drawLegend` function:**
    - Small colored rectangles + text labels ("Yes" green, "No" red) in the top-right area of the chart.

    **Component structure:**
    - `useRef<HTMLCanvasElement>` for canvas, `useRef<HTMLDivElement>` for container.
    - `useCallback` wrapping the full redraw logic (DPI setup + draw call) with `[yes, no]` deps.
    - `useEffect(() => { redraw(); }, [redraw])` for data-change redraws.
    - Separate `useEffect` for ResizeObserver: observe container, call `requestAnimationFrame(redraw)` on resize, disconnect on cleanup.

    **High-DPI rendering (CRITICAL -- blurry without this):**
    ```typescript
    const dpr = window.devicePixelRatio || 1;
    const rect = container.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    canvas.style.width = `${rect.width}px`;
    canvas.style.height = `${rect.height}px`;
    ctx.scale(dpr, dpr);
    ```
    Then draw using `rect.width` and `rect.height` as logical dimensions.

    **Empty state:**
    If both `yes` and `no` arrays are empty, draw "No depth data" centered on canvas instead of axes/grid.

    **Accessibility:**
    - Canvas element: `role="img"`, `aria-label` describing the data (e.g., "Depth chart: N Yes levels, M No levels").
    - Fallback text content inside `<canvas>` tag for screen readers.

    **Export:** Named export `DepthChart`.

    ---

    **Modify `dashboard/src/components/playground/orderbook-preview.tsx`:**

    Export the `isOrderbookData` type guard and `OrderbookData` interface so `response-panel.tsx` can import them:
    - Change `interface OrderbookData` to `export interface OrderbookData`
    - Change `function isOrderbookData` to `export function isOrderbookData`
    - Also export `interface OrderbookLevel` (though this exists in types/api.ts too, keeping the local one exported avoids breaking the existing file's internal usage).

    No other changes to orderbook-preview.tsx.
  </action>
  <verify>
    Run `cd /Users/samuelclark/Desktop/kalshibook/dashboard && npx tsc --noEmit` and confirm no TypeScript errors in the new or modified files.
  </verify>
  <done>
    - `depth-chart.tsx` exists with DepthChart component exported
    - Component accepts `yes`, `no` (OrderbookLevel[]), and optional `className` props
    - Canvas rendering uses devicePixelRatio scaling
    - ResizeObserver handles responsive sizing with cleanup
    - Cumulative depth computed correctly (Yes: descending price accumulation, No: ascending price accumulation)
    - Stepped area fills drawn in green (Yes) and red (No)
    - Grid, axes, labels, and legend drawn
    - Empty state handled (both sides empty shows message)
    - `isOrderbookData` and `OrderbookData` exported from `orderbook-preview.tsx`
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire depth tab into response panel</name>
  <files>
    dashboard/src/components/playground/response-panel.tsx
  </files>
  <action>
    **Modify `dashboard/src/components/playground/response-panel.tsx`:**

    Add a "Depth" tab alongside the existing "JSON" and "Preview" tabs, conditionally shown when response data is orderbook-shaped.

    **Imports to add:**
    ```typescript
    import { DepthChart } from "@/components/playground/depth-chart";
    import { isOrderbookData } from "@/components/playground/orderbook-preview";
    import type { OrderbookData } from "@/components/playground/orderbook-preview";
    ```

    **In the response state section (after destructuring `data`):**
    Add a local const: `const showDepth = isOrderbookData(data);`

    **In the Tabs component, update the TabsList to include the Depth trigger:**
    ```tsx
    <TabsList>
      <TabsTrigger value="json">JSON</TabsTrigger>
      <TabsTrigger value="preview">Preview</TabsTrigger>
      {showDepth && <TabsTrigger value="depth">Depth</TabsTrigger>}
    </TabsList>
    ```

    **After the Preview TabsContent, add the Depth TabsContent:**
    ```tsx
    {showDepth && (
      <TabsContent value="depth" className="px-4 pb-4 pt-2">
        <DepthChart
          yes={(data as OrderbookData).yes}
          no={(data as OrderbookData).no}
          className="h-[400px] w-full"
        />
      </TabsContent>
    )}
    ```

    The `h-[400px]` gives the canvas container a fixed height. The `w-full` ensures it fills the panel width.

    **Keep defaultValue="json"** -- do not auto-switch to depth tab (per research recommendation: consistent default behavior, less disorienting).

    No other changes to response-panel.tsx.
  </action>
  <verify>
    Run `cd /Users/samuelclark/Desktop/kalshibook/dashboard && npx tsc --noEmit` and confirm no TypeScript errors. Then run `npm run build` to verify the production build succeeds with no errors.
  </verify>
  <done>
    - Response panel shows "Depth" tab alongside "JSON" and "Preview" when response data is orderbook-shaped
    - Depth tab is hidden for non-orderbook responses
    - DepthChart receives yes[] and no[] from the orderbook response data
    - Default tab remains "json" (no auto-switching)
    - TypeScript compiles without errors
    - Production build succeeds
  </done>
</task>

</tasks>

<verification>
1. `cd dashboard && npx tsc --noEmit` -- TypeScript compilation passes
2. `cd dashboard && npm run build` -- Next.js production build succeeds
3. Manual check: Load playground, execute an orderbook request (e.g., via example card), confirm "Depth" tab appears alongside JSON and Preview
4. Manual check: Click "Depth" tab, confirm canvas renders with green (Yes) and red (No) stepped area fills, price axis 0-100 cents, quantity axis with labels
5. Manual check: Execute a non-orderbook request (e.g., trades), confirm "Depth" tab does NOT appear
6. Manual check: Resize the browser window, confirm depth chart redraws at new dimensions without blurriness
</verification>

<success_criteria>
- depth-chart.tsx exists and exports a working DepthChart Canvas component
- response-panel.tsx shows a "Depth" tab for orderbook data, hidden for other response types
- Canvas renders crisp on HiDPI displays (devicePixelRatio scaling)
- Chart shows Yes (green) and No (red) cumulative depth as stepped area fills
- Fixed 0-100 cent X-axis, dynamic Y-axis based on max cumulative quantity
- Chart resizes responsively via ResizeObserver
- TypeScript and Next.js build pass cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/15-depth-chart-visualization/15-01-SUMMARY.md`
</output>
