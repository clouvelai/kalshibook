# Stack Research

**Domain:** Python SDK + backtesting abstractions for existing KalshiBook REST API
**Researched:** 2026-02-17
**Confidence:** HIGH (core tooling well-established, ecosystem mature)

**Scope:** This document covers ONLY the new tooling needed for the Python SDK milestone. The existing backend stack (FastAPI, asyncpg, Supabase, Stripe, etc.) is already validated and deployed -- see the original STACK.md for those decisions.

---

## Decision Framework

This milestone adds three new concerns to the project:

1. **SDK Generation** -- Transform the existing OpenAPI 3.1 spec (auto-generated by FastAPI at `/openapi.json`) into a typed Python client library with sync and async support.
2. **SDK Packaging** -- Package and publish the generated client to PyPI as `kalshibook` so users can `pip install kalshibook`.
3. **Backtesting Abstractions** -- Hand-written ergonomic layer on top of the generated client: pagination iterators, data replay generators, and convenience helpers for backtesting workflows.

---

## Recommended Stack

### SDK Generation

| Technology | Version | Purpose | Why Recommended |
|------------|---------|---------|-----------------|
| openapi-python-client | ~0.28.2 | Generate typed Python client from OpenAPI 3.1 spec | The only actively maintained generator that produces modern Python (3.10+ type annotations, httpx, attrs). Supports OpenAPI 3.1 natively. Generates both `sync` and `asyncio` variants for every endpoint. Passes mypy strict. FastAPI's own docs point to it as a top option. 0.28.2 released Feb 2026. |

**What the generated code looks like:**

```
kalshibook/
  client.py          # Client + AuthenticatedClient classes (wrapping httpx)
  types.py           # UNSET, File, Response helpers
  models/            # attrs @define classes matching Pydantic response models
    orderbook_response.py
    deltas_response.py
    ...
  api/               # One module per OpenAPI tag
    orderbook/
      get_orderbook.py   # sync() and asyncio() functions
    deltas/
      get_deltas.py
    ...
```

**Key behaviors:**
- Uses **httpx** for HTTP (both sync and async in same codebase)
- Uses **attrs** `@define` classes for models (not Pydantic -- see rationale below)
- Generates `sync()` and `asyncio()` function variants for every endpoint
- `AuthenticatedClient` supports Bearer token injection (maps to our API key auth)
- `--overwrite` flag enables CI regeneration without manual merges
- Custom Jinja2 templates can override any generated file if needed

### SDK Packaging & Build

| Technology | Version | Purpose | Why Recommended |
|------------|---------|---------|-----------------|
| uv | ~0.10.x | Build, package, publish to PyPI | Already used in the project. `uv build` produces sdist + wheel, `uv publish` uploads to PyPI. Replaces setuptools + twine + build. Fast, single tool. |
| uv_build | ~0.10.3 | Build backend (in pyproject.toml) | Zero-config for pure Python packages. Stable as of late 2025. Integrates with the uv executable for fast builds. |
| PyPI Trusted Publishing | -- | Credential-less publishing from GitHub Actions | No tokens to manage. OIDC-based auth between GitHub Actions and PyPI. PyPI no longer accepts username/password. |

**pyproject.toml for the SDK package:**

```toml
[project]
name = "kalshibook"
version = "0.1.0"
description = "Python client for the KalshiBook L2 orderbook data API"
requires-python = ">=3.10"
dependencies = [
    "httpx>=0.20.0,<1.0.0",
    "attrs>=21.3.0",
    "python-dateutil>=2.8.0",
]

[build-system]
requires = ["uv_build>=0.10.3,<0.11.0"]
build-backend = "uv_build"
```

### SDK Documentation

| Technology | Version | Purpose | Why Recommended |
|------------|---------|---------|-----------------|
| mkdocs-material | ~9.7.1 | Documentation site framework | Best-in-class Python docs theme. Markdown-native (no reStructuredText). Search, dark mode, code highlighting, admonitions built-in. Version 9.7.x is "final" -- all former Insiders features now free. |
| mkdocstrings[python] | ~2.0.2 | Auto-generate API reference from docstrings | Parses Python source via Griffe AST analysis. Cross-references, type annotations rendered, Google/NumPy docstring styles supported. Eliminates manual API reference maintenance. |

### Backtesting Abstractions (Hand-Written Layer)

| Library | Version | Purpose | Why Recommended |
|---------|---------|---------|-----------------|
| httpx | ~0.28.1 | HTTP client (already a generated dependency) | Already used by generated client. Provides `AsyncClient` for connection pooling, streaming via `aiter_lines()`, HTTP/2 support. |
| typing-extensions | ~4.x | Backport newer typing features | `AsyncIterator`, `Self` for Python 3.10 compatibility without importing from newer stdlib. |

**No additional runtime dependencies needed.** The backtesting abstractions are pure Python built on top of the generated httpx client.

### Development Tools (SDK-specific additions)

| Tool | Purpose | Notes |
|------|---------|-------|
| openapi-python-client CLI | SDK regeneration | `pipx install openapi-python-client --include-deps`. Run in CI or as Makefile target. |
| pytest-httpx | ~0.35.x | Mock httpx calls in SDK tests | Intercepts httpx requests without hitting real API. Test pagination, error handling, auth. |
| mypy | ~1.15.x | Type checking generated + hand-written code | Generated code passes mypy strict. Ensures hand-written backtesting layer maintains type safety. |

---

## Critical Architecture Decisions

### 1. openapi-python-client vs openapi-generator vs Hand-Written

**Decision: openapi-python-client for the networking layer, hand-written for backtesting abstractions.**

**Rationale (HIGH confidence):**

| Criterion | openapi-python-client | openapi-generator (Python) | Hand-Written |
|-----------|----------------------|---------------------------|-------------|
| HTTP library | httpx (modern, async) | urllib3 (legacy, sync-only) | Your choice |
| Models | attrs (lightweight) | Pydantic v2 (heavy) | Your choice |
| Async support | Yes (sync + asyncio) | No async generation | Your choice |
| OpenAPI 3.1 | Full support | Partial/lagging | N/A |
| Python version target | 3.10+ | 3.7+ (outdated patterns) | Your choice |
| Type checking | Passes mypy strict | Incomplete annotations | Your choice |
| Code quality | Clean, minimal | Verbose, boilerplate-heavy | Highest potential |
| Maintenance cost | Regenerate on spec change | Regenerate on spec change | Manual updates required |

**Why not fully hand-written:** The API has 10+ endpoints with complex Pydantic models. Hand-writing the HTTP/serialization layer means maintaining ~40 model classes and ~15 endpoint functions manually. When the API adds a field, you manually update the SDK. openapi-python-client eliminates this class of bugs.

**Why not openapi-generator:** It generates urllib3-based sync-only Python code targeting Python 3.7. The output is verbose, requires manual cleanup, and does not support async. For a 2026 Python SDK targeting quant/algo users, this is unacceptable.

**Why not Speakeasy/Stainless/liblab:** Commercial tools ($$). Over-engineered for a 10-endpoint API. Vendor lock-in. The free tier limitations make CI regeneration awkward.

**The hybrid approach:** Generate the networking layer (client, models, endpoint functions) with openapi-python-client. Hand-write the backtesting ergonomic layer (pagination iterators, replay generators, convenience methods) on top. This gives you: automatic sync with API spec changes + idiomatic Python DX for backtesting users.

### 2. attrs Models in SDK vs Pydantic Models in API

**Decision: Accept attrs in the SDK. Do NOT fight the generator.**

**Rationale (HIGH confidence):**
- openapi-python-client generates attrs `@define` classes, not Pydantic `BaseModel`.
- There is a community fork (`openapi-python-client-pydantic`) but it has 0 stars, no releases, and appears abandoned. Not production-viable.
- attrs is lighter than Pydantic (no validation overhead on construction), which is actually better for an SDK client where data is already validated server-side.
- The SDK user never needs to construct response models -- they only read them. attrs `@define` provides slots, frozen, and `__eq__` which is all they need.
- If SDK users need Pydantic models for their own code, the backtesting layer can provide `.to_dict()` convenience or Pydantic adapter utilities.

### 3. Documentation: mkdocs-material vs pdoc vs Sphinx

**Decision: mkdocs-material + mkdocstrings for docs site.**

**Rationale (HIGH confidence):**

| Criterion | mkdocs-material | pdoc | Sphinx |
|-----------|----------------|------|--------|
| Markup | Markdown | Markdown | reStructuredText |
| Setup complexity | Low | Very low | High |
| API reference auto-gen | Via mkdocstrings plugin | Built-in | Via autodoc |
| Guides/tutorials | Excellent | Not designed for it | Excellent |
| Look & feel | Modern, polished | Simple, minimal | Dated (unless themed) |
| SDK docs precedent | Used by httpx, Pydantic, FastAPI ecosystem | Smaller projects | NumPy, Django |
| Maintenance status | 9.7.x is final, maintenance mode (12mo min) | Active (v16.0.0) | Active |

- **pdoc** is too simple. SDK docs need guides (Getting Started, Authentication, Backtesting Quickstart) alongside API reference. pdoc only does API reference.
- **Sphinx** has a steep learning curve and reStructuredText is hostile to contributors. Not worth it for a focused SDK.
- **mkdocs-material** is the standard for modern Python SDK docs. The httpx and Pydantic projects both use it. Version 9.7.x is stable and will be maintained at least through late 2026. If Zensical (its successor) matures, migration is designed to be straightforward.

### 4. Backtesting Abstractions: SDK Patterns

**Decision: Async generators for replay, `__aiter__` pagination, thin convenience wrappers.**

**Patterns to implement in the hand-written layer:**

```python
# 1. Auto-pagination iterator
async for delta in client.iter_deltas("KXBTC-26FEB17", start, end):
    process(delta)  # Handles cursor-based pagination transparently

# 2. Replay generator (time-ordered data feed)
async for event in client.replay("KXBTC-26FEB17", start, end):
    # Yields deltas + trades in chronological order
    # Simulates real-time feed for backtesting
    if event.type == "delta":
        update_book(event.data)
    elif event.type == "trade":
        check_signal(event.data)

# 3. Sync equivalents
for delta in client.iter_deltas_sync("KXBTC-26FEB17", start, end):
    process(delta)
```

**Key design decisions:**
- Use `AsyncIterator[T]` protocol (not callbacks, not event emitters)
- Lazy evaluation: pages fetched on-demand, not all at once
- Sync wrappers use `httpx.Client` (not `asyncio.run()` wrapping async)
- No dependency on pandas, numpy, or any data science library (users bring their own)

### 5. SDK Package Structure

**Decision: Monorepo with SDK as a subdirectory, not a separate repo.**

**Rationale:**
- The OpenAPI spec is generated from the API code in the same repo
- CI can regenerate the SDK whenever the API spec changes
- Versioning stays synchronized between API and SDK
- Backtesting layer tests can use the real API in integration tests

```
kalshibook/
  src/                    # Existing API code
    api/
    collector/
    shared/
  sdk/                    # NEW: SDK package
    kalshibook/           # The importable package
      _generated/         # openapi-python-client output (regenerated)
        client.py
        models/
        api/
      backtesting/        # Hand-written abstractions
        iterators.py
        replay.py
      __init__.py         # Public API surface
    pyproject.toml        # SDK-specific pyproject.toml
    docs/                 # mkdocs site source
    tests/
  Makefile                # `make sdk-generate`, `make sdk-test`, `make sdk-publish`
```

---

## Installation

### SDK Generator (development tooling)

```bash
# Install the generator tool (not a project dependency)
pipx install openapi-python-client --include-deps

# Or via uv tool
uv tool install openapi-python-client --with httpx
```

### SDK Package Dependencies (what users install)

```bash
# End users
pip install kalshibook
# or
uv add kalshibook
```

### SDK Development Dependencies

```bash
# In sdk/ directory
uv add httpx attrs python-dateutil   # Runtime deps
uv add --dev pytest pytest-httpx pytest-asyncio mypy ruff  # Dev deps
uv add --dev mkdocs-material "mkdocstrings[python]"        # Docs deps
```

### SDK Regeneration

```bash
# Fetch live spec and regenerate client code
openapi-python-client generate \
  --url http://localhost:8000/openapi.json \
  --config sdk/generator-config.yaml \
  --output-path sdk/kalshibook/_generated \
  --overwrite

# Or from saved spec file
openapi-python-client generate \
  --path openapi.json \
  --config sdk/generator-config.yaml \
  --output-path sdk/kalshibook/_generated \
  --overwrite
```

---

## Alternatives Considered

| Category | Recommended | Alternative | Why Not the Alternative |
|----------|-------------|-------------|------------------------|
| SDK generator | openapi-python-client | openapi-generator | Generates urllib3 sync-only code. Python 3.7 target. Verbose output. No async. Java dependency for running the generator. |
| SDK generator | openapi-python-client | Speakeasy | Commercial tool. $250+/mo for CI regeneration. Overkill for 10 endpoints. Vendor lock-in. |
| SDK generator | openapi-python-client | Hand-written | 40+ model classes to maintain manually. Every API field change needs SDK update. High maintenance cost for low-value mechanical work. |
| SDK generator | openapi-python-client | Stainless | Commercial, closed-source. Designed for OpenAI-scale APIs with dozens of endpoints. |
| SDK generator | openapi-python-client | python-client-generator (sennder) | Unmaintained (last commit 2024). No OpenAPI 3.1 support. Limited community. |
| Model library | attrs (generated) | Pydantic (via fork) | Fork is abandoned (0 stars, no releases). Fighting the generator creates maintenance burden. attrs is fine for read-only response models. |
| Build backend | uv_build | hatchling | uv_build is simpler for pure Python packages. No hooks or plugins needed. Hatchling is for when you need VCS-derived versions or build hooks. |
| Build backend | uv_build | setuptools | Legacy. Requires setup.cfg or setup.py. uv_build is the modern default. |
| Build backend | uv_build | poetry-core | Would require Poetry for dependency management. Project already uses uv. |
| Docs | mkdocs-material | Sphinx | reStructuredText markup, steep learning curve, dated look without extensive theming. |
| Docs | mkdocs-material | pdoc | API reference only. Cannot write guides, tutorials, getting started pages. Too limited for SDK docs. |
| Docs | mkdocs-material | Mintlify/ReadMe | Hosted commercial docs. Cost. Vendor lock-in. Markdown-compatible but not local-first. |
| HTTP client | httpx (generated) | requests | No async support. openapi-python-client does not generate requests-based code. |
| Packaging | PyPI via uv publish | GitHub Packages | PyPI is where Python users look. GitHub Packages has low discoverability for Python. |

---

## What NOT to Use

| Avoid | Why | Use Instead |
|-------|-----|-------------|
| openapi-generator (Java-based) | Generates sync-only urllib3 code with Python 3.7 patterns. Requires Java to run. Output needs manual cleanup. | openapi-python-client |
| openapi-python-client-pydantic (fork) | 0 stars, no releases, appears abandoned. Not production-viable. | Standard openapi-python-client with attrs |
| Speakeasy / Stainless / liblab | Commercial tools. $250+/mo minimum. Over-engineered for a small API. | openapi-python-client (free, open-source) |
| pandas/numpy as SDK dependencies | SDK users should bring their own data tools. Adding these inflates install size by 100MB+ and creates version conflicts. | Return plain Python objects. Users convert to DataFrames themselves. |
| datamodel-code-generator | Generates only Pydantic models, not full client. Still need httpx client code. | openapi-python-client (generates complete client) |
| swagger-codegen | Deprecated predecessor to openapi-generator. Even worse output quality. | openapi-python-client |
| Sphinx with autodoc | reStructuredText requirement, complex config, dated output. | mkdocs-material + mkdocstrings |
| Read the Docs hosting | Free tier has ads. Self-hosted docs on GitHub Pages is cleaner for an SDK. | GitHub Pages with mkdocs gh-deploy |

---

## Version Compatibility

| Package | Compatible With | Notes |
|---------|-----------------|-------|
| openapi-python-client ~0.28.2 | Python >=3.10, <4.0 | Generator tool, not a runtime dependency of the SDK. |
| httpx ~0.28.1 | Python >=3.8 | SDK runtime dependency. Wide compatibility. |
| attrs >=21.3.0 | Python >=3.7 | SDK runtime dependency. Very stable API. |
| mkdocs-material ~9.7.1 | Python >=3.8, MkDocs >=1.6 | Dev/docs dependency only. |
| mkdocstrings[python] ~2.0.2 | mkdocs-material >=9.0 | Dev/docs dependency only. |
| pytest-httpx ~0.35.x | httpx >=0.20.0, pytest >=8.0 | Dev dependency only. |
| mypy ~1.15.x | Python >=3.9 | Dev dependency only. |
| uv_build ~0.10.3 | Python >=3.8 | Build backend, declared in pyproject.toml [build-system]. |

---

## Stack Patterns by Variant

**If MVP SDK (get it out fast):**
- Generate client with openapi-python-client
- Add a thin `__init__.py` re-exporting key classes
- Hand-write 2-3 pagination iterators for deltas and trades
- Ship to PyPI with minimal docs (README + docstrings)
- No replay abstractions yet

**If full SDK (backtesting-focused):**
- Generated client in `_generated/` subdirectory
- Hand-written `backtesting/` module with replay generators
- Full mkdocs-material site with Getting Started guide, Authentication, Backtesting Quickstart, API Reference
- GitHub Actions: regenerate SDK on API spec change, publish on tag
- Type-checked with mypy strict

**If SDK grows (multi-language, enterprise):**
- Consider Speakeasy or Stainless at that point (their value proposition improves with more languages and endpoints)
- The OpenAPI 3.1 spec is the source of truth regardless of generator
- Generator migration is low-risk: swap the tool, keep the hand-written abstractions

---

## Sources

- [openapi-python-client GitHub](https://github.com/openapi-generators/openapi-python-client) -- Feature set, generated code structure, httpx + attrs (HIGH)
- [openapi-python-client PyPI](https://pypi.org/project/openapi-python-client/) -- v0.28.2 confirmed, Python >=3.10 (HIGH)
- [openapi-python-client releases](https://github.com/openapi-generators/openapi-python-client/releases) -- v0.28.0 Jan 2026, active development (HIGH)
- [openapi-python-client DeepWiki](https://deepwiki.com/openapi-generators/openapi-python-client) -- Generated code structure, dual sync/async, AuthenticatedClient (HIGH)
- [openapi-python-client-pydantic fork](https://github.com/izeberg/openapi-python-client-pydantic) -- 0 stars, no releases, abandoned (HIGH -- confirmed not viable)
- [Pydantic models discussion #837](https://github.com/openapi-generators/openapi-python-client/discussions/837) -- attrs chosen over Pydantic rationale (HIGH)
- [FastAPI SDK generation docs](https://fastapi.tiangolo.com/advanced/generate-clients/) -- Recommends OpenAPI Generator, links to openapi-python-client ecosystem (HIGH)
- [Speakeasy OSS comparison](https://www.speakeasy.com/docs/sdks/languages/python/oss-comparison-python) -- openapi-generator limitations: urllib3, no async, Python 3.7 target (MEDIUM -- vendor comparison, potential bias)
- [uv build backend docs](https://docs.astral.sh/uv/concepts/build-backend/) -- uv_build ~0.10.3, configuration, pure Python support (HIGH)
- [uv package publishing guide](https://docs.astral.sh/uv/guides/package/) -- `uv build` + `uv publish`, trusted publishing (HIGH)
- [Python Packaging User Guide](https://packaging.python.org/en/latest/guides/writing-pyproject-toml/) -- pyproject.toml spec (HIGH)
- [2026 Golden Path article](https://medium.com/@diwasb54/the-2026-golden-path-building-and-publishing-python-packages-with-a-single-tool-uv-b19675e02670) -- uv as default packaging tool in 2026 (MEDIUM)
- [mkdocs-material PyPI](https://pypi.org/project/mkdocs-material/) -- v9.7.1, Dec 2025, entering maintenance mode (HIGH)
- [mkdocs-material Insiders announcement](https://squidfunk.github.io/mkdocs-material/blog/2025/11/11/insiders-now-free-for-everyone/) -- All features now free in 9.7.0 (HIGH)
- [mkdocs-material Zensical announcement](https://squidfunk.github.io/mkdocs-material/blog/2025/11/05/zensical/) -- Successor project, maintenance mode for mkdocs-material (MEDIUM)
- [mkdocstrings GitHub](https://github.com/mkdocstrings/mkdocstrings) -- Auto-generate API docs from docstrings (HIGH)
- [pdoc.dev](https://pdoc.dev/) -- v16.0.0, lightweight API docs, no guide support (HIGH)
- [httpx PyPI](https://pypi.org/project/httpx/) -- v0.28.1, Python 3.8+ (HIGH)
- [httpx async docs](https://www.python-httpx.org/async/) -- AsyncClient, streaming, aiter_bytes (HIGH)
- [Building great SDKs (Pragmatic Engineer)](https://newsletter.pragmaticengineer.com/p/building-great-sdks) -- Hybrid approach: generate networking, hand-write ergonomics (HIGH)
- [Stainless blog: build vs buy SDKs](https://www.stainless.com/blog/build-vs-buy-sdks) -- Quality gap narrowing, generate + customize recommended (MEDIUM)
- [KalshiBook OpenAPI spec](http://localhost:8000/openapi.json) -- Confirmed OpenAPI 3.1.0 output from FastAPI (HIGH)
- [openapi-python-client custom templates](https://deepwiki.com/openapi-generators/openapi-python-client/5.1-custom-templates) -- Jinja2 override system, partial template replacement (HIGH)
- [openapi-python-client regeneration](https://github.com/openapi-generators/openapi-python-client/discussions/982) -- `--overwrite` flag, CI workflow patterns (HIGH)

---
*Stack research for: KalshiBook Python SDK + Backtesting Abstractions*
*Researched: 2026-02-17*
